{% extends "base.html" %}

{% block title %}ç³»ç»Ÿç»´æŠ¤ - å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨{% endblock %}

{% block extra_css %}
<style>
.maintenance-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-lg);
}

.maintenance-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-xl) 0;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: var(--white);
    border-radius: var(--border-radius-lg);
}

.test-section {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
}

.test-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-md);
}

.test-item {
    padding: var(--spacing-md);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-md);
    background: var(--gray-50);
}

.test-result {
    margin-top: var(--spacing-sm);
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-sm);
    font-family: monospace;
    font-size: var(--font-size-sm);
}

.success { background: var(--success-light); color: var(--success-color); }
.error { background: var(--danger-light); color: var(--danger-color); }
.loading { background: var(--info-light); color: var(--info-color); }
</style>
{% endblock %}

{% block content %}
<div class="maintenance-container">
    <section class="maintenance-header">
        <h1>ğŸ”§ ç³»ç»Ÿç»´æŠ¤</h1>
        <p>é¡µé¢å’ŒAPIæµ‹è¯•å·¥å…·</p>
    </section>

    <section class="test-section">
        <h2>ğŸ“± é¡µé¢æµ‹è¯•</h2>
        <div class="test-grid">
            <div class="test-item">
                <h4>åŸºç¡€é¡µé¢</h4>
                <button onclick="testPage('/', 'é¦–é¡µ')" class="btn btn-sm btn-primary">æµ‹è¯•é¦–é¡µ</button>
                <button onclick="testPage('/user/select', 'ç”¨æˆ·é€‰æ‹©')" class="btn btn-sm btn-secondary">æµ‹è¯•ç”¨æˆ·é€‰æ‹©</button>
                <div id="basic-pages-result" class="test-result"></div>
            </div>
            
            <div class="test-item">
                <h4>å‚æ•°å¤„ç†æµ‹è¯•</h4>
                <button onclick="testParameterHandling()" class="btn btn-sm btn-warning">æµ‹è¯•å‚æ•°å¤„ç†</button>
                <div id="param-result" class="test-result"></div>
            </div>
            
            <div class="test-item">
                <h4>APIæµ‹è¯•</h4>
                <button onclick="testAPI()" class="btn btn-sm btn-info">æµ‹è¯•API</button>
                <div id="api-result" class="test-result"></div>
            </div>
        </div>
    </section>

    <section class="test-section">
        <h2>ğŸ§ª è¯¦ç»†æµ‹è¯•</h2>
        <div class="test-grid">
            <div class="test-item">
                <h4>è¯åº“ç›¸å…³</h4>
                <button onclick="testWords()" class="btn btn-sm btn-success">æµ‹è¯•è¯åº“åŠŸèƒ½</button>
                <div id="words-result" class="test-result"></div>
            </div>
            
            <div class="test-item">
                <h4>ç”¨æˆ·ç›¸å…³</h4>
                <button onclick="testUsers()" class="btn btn-sm btn-success">æµ‹è¯•ç”¨æˆ·åŠŸèƒ½</button>
                <div id="users-result" class="test-result"></div>
            </div>
            
            <div class="test-item">
                <h4>ç¼“å­˜ç³»ç»Ÿ</h4>
                <button onclick="testCache()" class="btn btn-sm btn-success">æµ‹è¯•ç¼“å­˜</button>
                <div id="cache-result" class="test-result"></div>
            </div>
        </div>
    </section>

    <section class="test-section">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
        <div id="system-status">
            <button onclick="checkSystemStatus()" class="btn btn-primary">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <div id="status-result" class="test-result"></div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showResult(elementId, message, type = 'success') {
    const element = document.getElementById(elementId);
    element.className = `test-result ${type}`;
    element.textContent = message;
}

function showLoading(elementId, message = 'æµ‹è¯•ä¸­...') {
    showResult(elementId, message, 'loading');
}

async function testPage(url, description) {
    showLoading('basic-pages-result', `æµ‹è¯•${description}...`);
    
    try {
        const response = await fetch(url);
        if (response.ok) {
            showResult('basic-pages-result', `âœ… ${description}æµ‹è¯•æˆåŠŸ`, 'success');
        } else {
            showResult('basic-pages-result', `âŒ ${description}æµ‹è¯•å¤±è´¥: ${response.status}`, 'error');
        }
    } catch (error) {
        showResult('basic-pages-result', `âŒ ${description}æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
    }
}

async function testParameterHandling() {
    showLoading('param-result', 'æµ‹è¯•å‚æ•°å¤„ç†...');
    
    const testCases = [
        { url: '/api/words?grade=&unit=', desc: 'ç©ºå‚æ•°' },
        { url: '/api/words?grade=abc&unit=xyz', desc: 'éæ•°å­—å‚æ•°' },
        { url: '/api/words?grade=3&unit=1', desc: 'æ­£å¸¸å‚æ•°' },
    ];
    
    let results = [];
    
    for (const testCase of testCases) {
        try {
            const response = await fetch(testCase.url);
            if (response.ok) {
                results.push(`âœ… ${testCase.desc}`);
            } else {
                results.push(`âŒ ${testCase.desc}: ${response.status}`);
            }
        } catch (error) {
            results.push(`âŒ ${testCase.desc}: ${error.message}`);
        }
    }
    
    showResult('param-result', results.join('\n'), results.every(r => r.startsWith('âœ…')) ? 'success' : 'error');
}

async function testAPI() {
    showLoading('api-result', 'æµ‹è¯•API...');
    
    const apis = [
        '/api/words',
        '/api/words/grades', 
        '/api/words/statistics',
        '/api/users',
        '/api/cache/stats'
    ];
    
    let results = [];
    
    for (const api of apis) {
        try {
            const response = await fetch(api);
            const data = await response.json();
            
            if (response.ok && data.success !== false) {
                results.push(`âœ… ${api}`);
            } else {
                results.push(`âŒ ${api}: ${data.error || response.status}`);
            }
        } catch (error) {
            results.push(`âŒ ${api}: ${error.message}`);
        }
    }
    
    showResult('api-result', results.join('\n'), results.every(r => r.startsWith('âœ…')) ? 'success' : 'error');
}

async function testWords() {
    showLoading('words-result', 'æµ‹è¯•è¯åº“åŠŸèƒ½...');
    
    try {
        // æµ‹è¯•è·å–å¹´çº§
        const gradesResponse = await fetch('/api/words/grades');
        const gradesData = await gradesResponse.json();
        
        if (!gradesData.success) throw new Error('è·å–å¹´çº§å¤±è´¥');
        
        // æµ‹è¯•è·å–å•å…ƒ
        const unitsResponse = await fetch('/api/words/units/3');
        const unitsData = await unitsResponse.json();
        
        if (!unitsData.success) throw new Error('è·å–å•å…ƒå¤±è´¥');
        
        // æµ‹è¯•è·å–è¯åº“
        const wordsResponse = await fetch('/api/words?grade=3&unit=1');
        const wordsData = await wordsResponse.json();
        
        if (!wordsData.success) throw new Error('è·å–è¯åº“å¤±è´¥');
        
        showResult('words-result', `âœ… è¯åº“åŠŸèƒ½æ­£å¸¸\nå¹´çº§æ•°: ${gradesData.data.length}\nå•å…ƒæ•°: ${unitsData.data.length}\nè¯æ±‡æ•°: ${wordsData.count}`, 'success');
        
    } catch (error) {
        showResult('words-result', `âŒ è¯åº“åŠŸèƒ½é”™è¯¯: ${error.message}`, 'error');
    }
}

async function testUsers() {
    showLoading('users-result', 'æµ‹è¯•ç”¨æˆ·åŠŸèƒ½...');
    
    try {
        const response = await fetch('/api/users');
        const data = await response.json();
        
        if (data.success) {
            showResult('users-result', `âœ… ç”¨æˆ·åŠŸèƒ½æ­£å¸¸\nç”¨æˆ·æ•°: ${data.count}`, 'success');
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showResult('users-result', `âŒ ç”¨æˆ·åŠŸèƒ½é”™è¯¯: ${error.message}`, 'error');
    }
}

async function testCache() {
    showLoading('cache-result', 'æµ‹è¯•ç¼“å­˜ç³»ç»Ÿ...');
    
    try {
        const response = await fetch('/api/cache/health');
        const data = await response.json();
        
        if (data.success) {
            showResult('cache-result', `âœ… ç¼“å­˜ç³»ç»Ÿæ­£å¸¸\nçŠ¶æ€: ${data.data.status}`, 'success');
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showResult('cache-result', `âŒ ç¼“å­˜ç³»ç»Ÿé”™è¯¯: ${error.message}`, 'error');
    }
}

async function checkSystemStatus() {
    showLoading('status-result', 'æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
    
    try {
        const checks = [
            { name: 'åº”ç”¨å“åº”', url: '/', check: r => r.ok },
            { name: 'APIå¯ç”¨æ€§', url: '/api/words', check: r => r.ok },
            { name: 'ç¼“å­˜æœåŠ¡', url: '/api/cache/stats', check: r => r.ok },
        ];
        
        let results = [];
        
        for (const check of checks) {
            try {
                const response = await fetch(check.url);
                if (check.check(response)) {
                    results.push(`âœ… ${check.name}: æ­£å¸¸`);
                } else {
                    results.push(`âŒ ${check.name}: å¼‚å¸¸ (${response.status})`);
                }
            } catch (error) {
                results.push(`âŒ ${check.name}: é”™è¯¯ (${error.message})`);
            }
        }
        
        const allOk = results.every(r => r.startsWith('âœ…'));
        showResult('status-result', 
            `ç³»ç»Ÿæ£€æŸ¥å®Œæˆ:\n${results.join('\n')}\n\næ•´ä½“çŠ¶æ€: ${allOk ? 'âœ… æ­£å¸¸' : 'âš ï¸ æœ‰é—®é¢˜'}`, 
            allOk ? 'success' : 'error'
        );
        
    } catch (error) {
        showResult('status-result', `âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
document.addEventListener('DOMContentLoaded', function() {
    checkSystemStatus();
});
</script>
{% endblock %}
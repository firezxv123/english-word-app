{% extends "base.html" %}

{% block title %}è¯åº“æµè§ˆ - å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/word-list.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <section class="word-list-header">
        <h1>ğŸ“š è¯åº“æµè§ˆ</h1>
        <p class="page-description">æµè§ˆå’Œç®¡ç†å°å­¦è‹±è¯­å•è¯åº“</p>
    </section>

    <!-- ç­›é€‰å™¨ -->
    <section class="filter-section">
        <div class="filter-card">
            <h3 class="filter-title">ğŸ” ç­›é€‰æ¡ä»¶</h3>
            
            <form id="filterForm" class="filter-form">
                <div class="filter-row">
                    <div class="form-group">
                        <label for="gradeSelect" class="form-label">å¹´çº§ï¼š</label>
                        <select id="gradeSelect" name="grade" class="form-select">
                            <option value="">æ‰€æœ‰å¹´çº§</option>
                            {% for grade in grades %}
                            <option value="{{ grade }}" {% if grade == selected_grade %}selected{% endif %}>
                                {{ grade }}å¹´çº§
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="unitSelect" class="form-label">å•å…ƒï¼š</label>
                        <select id="unitSelect" name="unit" class="form-select">
                            <option value="">æ‰€æœ‰å•å…ƒ</option>
                            {% for unit in units %}
                            <option value="{{ unit }}" {% if unit == selected_unit %}selected{% endif %}>
                                ç¬¬{{ unit }}å•å…ƒ
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            ğŸ” ç­›é€‰
                        </button>
                        <button type="button" id="resetFilter" class="btn btn-secondary">
                            ğŸ”„ é‡ç½®
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <!-- è¯åº“ç»Ÿè®¡ -->
    <section class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <div class="stat-value">{{ words|length }}</div>
                    <div class="stat-label">å½“å‰æ˜¾ç¤ºå•è¯</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ“š</div>
                <div class="stat-content">
                    <div class="stat-value">{{ grades|length }}</div>
                    <div class="stat-label">å¹´çº§æ•°é‡</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ“–</div>
                <div class="stat-content">
                    <div class="stat-value">{{ units|length }}</div>
                    <div class="stat-label">å•å…ƒæ•°é‡</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-content">
                    <div class="stat-value">PEP</div>
                    <div class="stat-label">æ•™æç‰ˆæœ¬</div>
                </div>
            </div>
        </div>
    </section>

    <!-- å•è¯åˆ—è¡¨ -->
    <section class="word-list-section">
        {% if words %}
        <div class="word-list-controls">
            <div class="list-info">
                <span class="word-count">å…± {{ words|length }} ä¸ªå•è¯</span>
            </div>
            <div class="list-actions">
                <button id="exportBtn" class="btn btn-outline-primary">
                    ğŸ“¤ å¯¼å‡º
                </button>
                <button id="printBtn" class="btn btn-outline-secondary">
                    ğŸ–¨ï¸ æ‰“å°
                </button>
            </div>
        </div>

        <div class="word-grid" id="wordGrid">
            {% for word in words %}
            <div class="word-card" data-word-id="{{ word.id }}">
                <div class="word-header">
                    <h3 class="word-english">{{ word.word }}</h3>
                    <span class="word-phonetic">{{ word.phonetic or '' }}</span>
                </div>
                
                <div class="word-content">
                    <div class="word-meaning">
                        <strong>{{ word.chinese_meaning }}</strong>
                    </div>
                    
                    {% if word.phonics_breakdown %}
                    <div class="word-phonics">
                        <span class="label">æ‹¼è¯»ï¼š</span>
                        <span class="content">{{ word.phonics_breakdown }}</span>
                    </div>
                    {% endif %}
                    
                    {% if word.memory_method %}
                    <div class="word-memory">
                        <span class="label">è®°å¿†ï¼š</span>
                        <span class="content">{{ word.memory_method }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="word-footer">
                    <div class="word-info">
                        <span class="grade-badge">{{ word.grade }}å¹´çº§</span>
                        <span class="unit-badge">ç¬¬{{ word.unit }}å•å…ƒ</span>
                    </div>
                    
                    <div class="word-actions">
                        <button class="btn-icon play-audio" data-word-id="{{ word.id }}" {% if word.audio_url %}data-audio="{{ word.audio_url }}"{% endif %} title="æ’­æ”¾å‘éŸ³">
                            ğŸ”Š
                        </button>
                        <button class="btn-icon view-detail" data-word-id="{{ word.id }}" title="æŸ¥çœ‹è¯¦æƒ…">
                            ğŸ‘ï¸
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- åˆ†é¡µæ§åˆ¶ -->
        <div class="pagination-container">
            <div class="pagination">
                <button class="btn btn-outline-primary" id="prevPage" disabled>
                    â† ä¸Šä¸€é¡µ
                </button>
                <span class="page-info">
                    ç¬¬ <span id="currentPage">1</span> é¡µï¼Œå…± <span id="totalPages">1</span> é¡µ
                </span>
                <button class="btn btn-outline-primary" id="nextPage" disabled>
                    ä¸‹ä¸€é¡µ â†’
                </button>
            </div>
        </div>
        
        {% else %}
        <!-- ç©ºçŠ¶æ€ -->
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <h3 class="empty-title">æš‚æ— å•è¯æ•°æ®</h3>
            <p class="empty-description">
                {% if selected_grade or selected_unit %}
                å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°å•è¯ï¼Œè¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶ã€‚
                {% else %}
                è¯åº“ä¸­æš‚æ— å•è¯æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥å•è¯ã€‚
                {% endif %}
            </p>
            <div class="empty-actions">
                {% if selected_grade or selected_unit %}
                <button id="clearFilter" class="btn btn-primary">
                    ğŸ”„ æ¸…é™¤ç­›é€‰
                </button>
                {% endif %}
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                    ğŸ  è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>
        {% endif %}
    </section>
</div>

<!-- å•è¯è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="wordDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">å•è¯è¯¦æƒ…</h3>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- åŠ¨æ€åŠ è½½å•è¯è¯¦æƒ… -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ç­›é€‰è¡¨å•
    const filterForm = document.getElementById('filterForm');
    const gradeSelect = document.getElementById('gradeSelect');
    const unitSelect = document.getElementById('unitSelect');
    const resetFilter = document.getElementById('resetFilter');
    
    // å¹´çº§å˜åŒ–æ—¶æ›´æ–°å•å…ƒé€‰é¡¹
    gradeSelect.addEventListener('change', function() {
        const selectedGrade = this.value;
        updateUnitOptions(selectedGrade);
    });
    
    // ç­›é€‰è¡¨å•æäº¤
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        applyFilter();
    });
    
    // é‡ç½®ç­›é€‰
    resetFilter.addEventListener('click', function() {
        gradeSelect.value = '';
        unitSelect.value = '';
        updateUnitOptions('');
        applyFilter();
    });
    
    // æ¸…é™¤ç­›é€‰ï¼ˆç©ºçŠ¶æ€ä¸‹çš„æŒ‰é’®ï¼‰
    const clearFilter = document.getElementById('clearFilter');
    if (clearFilter) {
        clearFilter.addEventListener('click', function() {
            window.location.href = '{{ url_for("main.word_list") }}';
        });
    }
    
    // æŸ¥çœ‹å•è¯è¯¦æƒ…
    document.querySelectorAll('.view-detail').forEach(button => {
        button.addEventListener('click', function() {
            const wordId = this.dataset.wordId;
            showWordDetail(wordId);
        });
    });
    
    // æ¨¡æ€æ¡†æ§åˆ¶
    const modal = document.getElementById('wordDetailModal');
    const closeModal = document.getElementById('closeModal');
    
    closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // å¯¼å‡ºåŠŸèƒ½
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            exportWords();
        });
    }
    
    // æ‰“å°åŠŸèƒ½
    const printBtn = document.getElementById('printBtn');
    if (printBtn) {
        printBtn.addEventListener('click', function() {
            printWordList();
        });
    }
    
    // å‡½æ•°å®šä¹‰
    function updateUnitOptions(grade) {
        if (!grade) {
            unitSelect.innerHTML = '<option value="">æ‰€æœ‰å•å…ƒ</option>';
            return;
        }
        
        // è·å–æŒ‡å®šå¹´çº§çš„å•å…ƒ
        ApiClient.words.getGradeUnits(grade)
            .then(response => {
                if (response.success) {
                    let options = '<option value="">æ‰€æœ‰å•å…ƒ</option>';
                    response.data.forEach(unit => {
                        options += `<option value="${unit}">ç¬¬${unit}å•å…ƒ</option>`;
                    });
                    unitSelect.innerHTML = options;
                }
            })
            .catch(error => {
                console.error('è·å–å•å…ƒåˆ—è¡¨å¤±è´¥:', error);
            });
    }
    
    function applyFilter() {
        const grade = gradeSelect.value;
        const unit = unitSelect.value;
        
        const params = new URLSearchParams();
        if (grade) params.append('grade', grade);
        if (unit) params.append('unit', unit);
        
        window.location.href = `{{ url_for("main.word_list") }}?${params.toString()}`;
    }
    
    function showWordDetail(wordId) {
        const modal = document.getElementById('wordDetailModal');
        const modalBody = document.getElementById('modalBody');
        
        modalBody.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        modal.style.display = 'block';
        
        ApiClient.words.getWord(wordId)
            .then(response => {
                if (response.success) {
                    const word = response.data;
                    modalBody.innerHTML = `
                        <div class="word-detail">
                            <div class="detail-section">
                                <h4>${word.word}</h4>
                                <p class="phonetic">${word.phonetic || ''}</p>
                                <p class="meaning"><strong>${word.chinese_meaning}</strong></p>
                            </div>
                            
                            ${word.phonics_breakdown ? `
                            <div class="detail-section">
                                <h5>è‡ªç„¶æ‹¼è¯»</h5>
                                <p>${word.phonics_breakdown}</p>
                            </div>
                            ` : ''}
                            
                            ${word.memory_method ? `
                            <div class="detail-section">
                                <h5>è®°å¿†æ–¹æ³•</h5>
                                <p>${word.memory_method}</p>
                            </div>
                            ` : ''}
                            
                            <div class="detail-section">
                                <h5>åŸºæœ¬ä¿¡æ¯</h5>
                                <p>å¹´çº§ï¼š${word.grade}å¹´çº§</p>
                                <p>å•å…ƒï¼šç¬¬${word.unit}å•å…ƒ</p>
                                <p>æ•™æç‰ˆæœ¬ï¼š${word.book_version}</p>
                            </div>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
                }
            })
            .catch(error => {
                console.error('è·å–å•è¯è¯¦æƒ…å¤±è´¥:', error);
                modalBody.innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
            });
    }
    
    function exportWords() {
        const grade = '{{ selected_grade or "" }}';
        const unit = '{{ selected_unit or "" }}';
        
        ApiClient.words.export('json', grade, unit)
            .then(response => {
                if (response.success) {
                    const blob = new Blob([JSON.stringify(response.data, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `words_${grade || 'all'}_${unit || 'all'}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    WordApp.showAlert('å¯¼å‡ºæˆåŠŸ', 'success');
                }
            })
            .catch(error => {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                WordApp.showAlert('å¯¼å‡ºå¤±è´¥', 'error');
            });
    }
    
    function printWordList() {
        window.print();
    }
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}é¦–é¡µ - å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/index.css') }}">
{% endblock %}

{% block content %}
<div class="home-container">
    <!-- æ¬¢è¿åŒºåŸŸ -->
    <section class="welcome-section">
        <div class="welcome-content">
            <h1 class="welcome-title">ğŸ“ å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨</h1>
            <p class="welcome-description">
                ä¸“ä¸ºå°å­¦3-6å¹´çº§å­¦ç”Ÿè®¾è®¡çš„äººæ•™ç‰ˆPEPæ•™æè‹±è¯­å•è¯å¤ä¹ èƒŒè¯µåº”ç”¨<br>
                æä¾›ç³»ç»ŸåŒ–çš„å•è¯å­¦ä¹ å’Œæµ‹éªŒåŠŸèƒ½ï¼Œå¸®åŠ©å­¦ç”Ÿæœ‰æ•ˆè®°å¿†å’ŒæŒæ¡è‹±è¯­è¯æ±‡
            </p>
            
            {% if not current_user %}
            <div class="welcome-actions">
                <a href="{{ url_for('main.select_user') }}" class="btn btn-primary btn-lg">
                    ğŸ‘¤ é€‰æ‹©ç”¨æˆ·å¼€å§‹å­¦ä¹ 
                </a>
                <a href="{{ url_for('main.create_user') }}" class="btn btn-secondary btn-lg">
                    â• åˆ›å»ºæ–°ç”¨æˆ·
                </a>
            </div>
            {% endif %}
        </div>
        
        {% if current_user %}
        <div class="user-welcome">
            <h2>æ¬¢è¿å›æ¥ï¼Œ{{ current_user.username }}ï¼</h2>
            <p class="user-grade">å½“å‰å¹´çº§ï¼š{{ current_user.grade }}å¹´çº§</p>
        </div>
        {% endif %}
    </section>

    {% if current_user %}
    <!-- ä¸»åŠŸèƒ½åŒº -->
    <section class="main-functions">
        <div class="function-grid">
            <!-- å¼€å§‹å­¦ä¹ å¡ç‰‡ -->
            <div class="function-card study-card">
                <div class="card-icon">ğŸ“–</div>
                <h3 class="card-title">å¼€å§‹å­¦ä¹ </h3>
                <p class="card-description">
                    ç³»ç»ŸåŒ–å­¦ä¹ å•è¯ï¼ŒåŒ…å«è‡ªç„¶æ‹¼è¯»å’Œè¶£å‘³è”æƒ³è®°å¿†æ³•
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('main.study_page', user_id=current_user.id) }}" class="btn btn-primary">
                        ç«‹å³å­¦ä¹ 
                    </a>
                </div>
            </div>

            <!-- è¿›è¡Œæµ‹éªŒå¡ç‰‡ -->
            <div class="function-card test-card">
                <div class="card-icon">ğŸ“</div>
                <h3 class="card-title">è¿›è¡Œæµ‹éªŒ</h3>
                <p class="card-description">
                    å¤šç§æµ‹è¯•æ¨¡å¼ï¼Œæ£€éªŒå­¦ä¹ æˆæœï¼Œå·©å›ºè®°å¿†æ•ˆæœ
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('main.test_page', user_id=current_user.id) }}" class="btn btn-primary">
                        å¼€å§‹æµ‹éªŒ
                    </a>
                </div>
            </div>

            <!-- å­¦ä¹ è¿›åº¦å¡ç‰‡ -->
            <div class="function-card progress-card">
                <div class="card-icon">ğŸ“Š</div>
                <h3 class="card-title">å­¦ä¹ è¿›åº¦</h3>
                <p class="card-description">
                    æŸ¥çœ‹å­¦ä¹ ç»Ÿè®¡ï¼Œäº†è§£æŒæ¡æƒ…å†µï¼Œåˆ¶å®šå­¦ä¹ è®¡åˆ’
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('main.dashboard', user_id=current_user.id) }}" class="btn btn-primary">
                        æŸ¥çœ‹è¿›åº¦
                    </a>
                </div>
            </div>

            <!-- è¯åº“ç®¡ç†å¡ç‰‡ -->
            <div class="function-card vocab-card">
                <div class="card-icon">ğŸ“š</div>
                <h3 class="card-title">è¯åº“ç®¡ç†</h3>
                <p class="card-description">
                    æµè§ˆå’Œç®¡ç†è¯åº“ï¼Œæ”¯æŒåœ¨çº¿æ›´æ–°å’Œæ‰‹åŠ¨å¯¼å…¥
                </p>
                <div class="card-actions">
                    <a href="{{ url_for('main.word_list') }}" class="btn btn-secondary">
                        ç®¡ç†è¯åº“
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- å­¦ä¹ ç»Ÿè®¡åŒº -->
    <section class="stats-section">
        <h2 class="stats-title">ğŸ“ˆ æˆ‘çš„å­¦ä¹ æ•°æ®</h2>
        <div class="stats-grid" id="userStatsGrid">
            <!-- é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½å­¦ä¹ ç»Ÿè®¡ -->
        </div>
    </section>
    {% endif %}

    <!-- è¯åº“ç»Ÿè®¡åŒº -->
    <section class="library-stats">
        <h2 class="stats-title">ğŸ“š è¯åº“æ¦‚å†µ</h2>
        {% if word_stats %}
        <div class="library-overview">
            <div class="stat-item">
                <span class="stat-number">{{ word_stats.total_words }}</span>
                <span class="stat-label">æ€»å•è¯æ•°</span>
            </div>
            
            {% if grades %}
            <div class="grade-stats">
                {% for grade in grades %}
                    {% set grade_count = word_stats.grade_stats|selectattr("grade", "equalto", grade)|map(attribute="count")|first or 0 %}
                    <div class="grade-item">
                        <span class="grade-number">{{ grade }}å¹´çº§</span>
                        <span class="grade-count">{{ grade_count }}ä¸ªå•è¯</span>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </section>

    <!-- åŠŸèƒ½ç‰¹è‰²ä»‹ç» -->
    <section class="features-section">
        <h2 class="features-title">âœ¨ åº”ç”¨ç‰¹è‰²</h2>
        <div class="features-grid">
            <div class="feature-item">
                <div class="feature-icon">ğŸ”¤</div>
                <h4>è‡ªç„¶æ‹¼è¯»æ‹†åˆ†</h4>
                <p>å°†å•è¯æŒ‰ç…§å‘éŸ³è§„å¾‹è¿›è¡Œåˆ†è§£ï¼Œå¸®åŠ©æŒæ¡æ‹¼è¯»æŠ€å·§</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">ğŸ’­</div>
                <h4>è¶£å‘³è”æƒ³è®°å¿†</h4>
                <p>é€šè¿‡æ•…äº‹ã€å›¾åƒç­‰æ–¹å¼å»ºç«‹è”æƒ³ï¼Œæé«˜è®°å¿†æ•ˆç‡</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">ğŸ“Š</div>
                <h4>æ™ºèƒ½è¿›åº¦è·Ÿè¸ª</h4>
                <p>å®æ—¶è®°å½•å­¦ä¹ è¿›åº¦ï¼Œåˆ†ææŒæ¡ç¨‹åº¦ï¼Œä¸ªæ€§åŒ–æ¨è</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">ğŸ¯</div>
                <h4>å¤šæ ·åŒ–æµ‹éªŒ</h4>
                <p>ä¸­è¯‘è‹±ã€è‹±è¯‘ä¸­ç­‰å¤šç§æµ‹è¯•æ¨¡å¼ï¼Œå…¨æ–¹ä½æ£€éªŒå­¦ä¹ æ•ˆæœ</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if current_user %}
    // åŠ è½½ç”¨æˆ·å­¦ä¹ ç»Ÿè®¡
    loadUserStats({{ current_user.id }});
    {% endif %}
});

{% if current_user %}
async function loadUserStats(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/dashboard`);
        const data = await response.json();
        
        if (data.success) {
            renderUserStats(data.data);
        }
    } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ç»Ÿè®¡å¤±è´¥:', error);
    }
}

function renderUserStats(stats) {
    const container = document.getElementById('userStatsGrid');
    
    const html = `
        <div class="stat-card">
            <div class="stat-icon">ğŸ“–</div>
            <div class="stat-content">
                <div class="stat-number">${stats.study_progress.total_studied}</div>
                <div class="stat-label">å·²å­¦ä¹ å•è¯</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">â­</div>
            <div class="stat-content">
                <div class="stat-number">${stats.study_progress.mastered}</div>
                <div class="stat-label">å·²æŒæ¡å•è¯</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
                <div class="stat-number">${stats.study_progress.mastery_rate}%</div>
                <div class="stat-label">æŒæ¡ç‡</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ“</div>
            <div class="stat-content">
                <div class="stat-number">${stats.test_statistics.total_tests}</div>
                <div class="stat-label">æµ‹éªŒæ¬¡æ•°</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}
{% endif %}
</script>
{% endblock %}
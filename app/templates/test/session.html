{% extends "base.html" %}

{% block title %}æµ‹éªŒè¿›è¡Œä¸­{% endblock %}

{% block content %}
<div class="test-session-page">
    <div class="test-header">
        <div class="test-info">
            <h2>{{ test.test_type_name }}</h2>
            <div class="test-meta">
                <span>ğŸ“ {{ test.total_questions }}é¢˜</span>
                <span id="timer">â±ï¸ 00:00</span>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="question-counter">
            <span id="currentQuestion">1</span> / {{ test.total_questions }}
        </div>
    </div>

    <div class="question-container" id="questionContainer">
        <!-- é¢˜ç›®å†…å®¹å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>

    <div class="test-controls">
        <button id="prevBtn" class="btn btn-outline" disabled>ä¸Šä¸€é¢˜</button>
        <button id="nextBtn" class="btn btn-primary">ä¸‹ä¸€é¢˜</button>
        <button id="submitBtn" class="btn btn-success" style="display: none;">æäº¤æµ‹éªŒ</button>
    </div>

    <!-- æµ‹éªŒæ•°æ® -->
    <script type="application/json" id="testData">{{ test | tojson | safe }}</script>
</div>

<style>
/* å…¨å±€ç¦ç”¨åŠ¨ç”» */
*, *::before, *::after {
    animation-duration: 0s !important;
    animation-delay: 0s !important;
    transition-duration: 0s !important;
    transition-delay: 0s !important;
    will-change: auto !important;
}

/* ç‰¹åˆ«ç¦ç”¨è¿›åº¦æ¡åŠ¨ç”» */
.progress-bar, .progress-bar *, 
.progress-fill, .progress-fill * {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    will-change: auto !important;
}

.test-session-page {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--spacing-lg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.test-header {
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    position: sticky;
    top: var(--spacing-md);
    z-index: 100;
}

.test-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.test-info h2 {
    margin: 0;
    color: var(--text-primary);
}

.test-meta {
    display: flex;
    gap: var(--spacing-lg);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.progress-bar {
    background: var(--border-color);
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: var(--spacing-sm);
}

.progress-fill {
    background: var(--primary-color);
    height: 100%;
    width: 0%;
    /* å®Œå…¨ç§»é™¤æ‰€æœ‰åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ */
    transition: none !important;
    animation: none !important;
    transform: none !important;
    will-change: auto !important;
}

.question-counter {
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
}

.question-container {
    flex: 1;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-xxl);
    margin-bottom: var(--spacing-xl);
}

.question {
    text-align: center;
}

.question-text {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xxl);
    line-height: 1.4;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    max-width: 600px;
    margin: 0 auto;
}

.option {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    cursor: pointer;
    transition: background-color 0.15s, border-color 0.15s;
    text-align: center;
    font-size: var(--font-size-md);
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    position: relative;
}

.option:hover {
    border-color: var(--primary-color);
    background: var(--primary-light);
}

.option.selected {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
}

.option.correct {
    border-color: var(--success-color);
    background: var(--success-color);
    color: white;
}

.option.wrong {
    border-color: var(--danger-color);
    background: var(--danger-color);
    color: white;
}

.test-controls {
    display: flex;
    justify-content: space-between;
    gap: var(--spacing-lg);
}

.test-controls button {
    flex: 1;
    max-width: 200px;
}

/* åŠ è½½çŠ¶æ€ */
.loading {
    text-align: center;
    padding: var(--spacing-xxl);
    color: var(--text-secondary);
}

/* å®ŒæˆçŠ¶æ€ */
.test-completed {
    text-align: center;
    padding: var(--spacing-xxl);
}

.completed-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
}

@media (max-width: 768px) {
    .test-session-page {
        padding: var(--spacing-sm);
    }
    
    .test-header {
        padding: var(--spacing-sm);
        position: static;
        margin-bottom: var(--spacing-md);
    }
    
    .test-info {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }
    
    .test-info h2 {
        font-size: 1.3rem;
    }
    
    .test-meta {
        gap: var(--spacing-sm);
        width: 100%;
        justify-content: space-between;
        font-size: 0.85rem;
    }
    
    .progress-bar {
        height: 4px;
    }
    
    .options-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
        max-width: none;
    }
    
    .option {
        padding: var(--spacing-md);
        font-size: 0.95rem;
        min-height: 44px;
        border-radius: var(--border-radius);
        border-width: 1px;
    }
    
    .test-controls {
        flex-direction: row;
        gap: var(--spacing-sm);
        position: sticky;
        bottom: var(--spacing-sm);
        background: var(--white);
        padding: var(--spacing-sm);
        border-radius: var(--border-radius);
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    
    .test-controls button {
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.9rem;
        border-radius: var(--border-radius);
        min-height: 44px;
    }
    
    .question-text {
        font-size: 1.1rem;
        margin-bottom: var(--spacing-md);
        line-height: 1.3;
    }
    
    .question-container {
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
    }
    
    .question-counter {
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .test-session-page {
        padding: var(--spacing-xs);
    }
    
    .test-header {
        padding: var(--spacing-xs);
    }
    
    .test-info h2 {
        font-size: 1.2rem;
    }
    
    .test-meta {
        font-size: 0.8rem;
    }
    
    .option {
        padding: var(--spacing-sm);
        font-size: 0.9rem;
        min-height: 40px;
    }
    
    .question-text {
        font-size: 1rem;
    }
    
    .test-controls button {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.85rem;
        min-height: 40px;
    }
}
</style>

<script>
class TestSession {
    constructor() {
        this.testData = JSON.parse(document.getElementById('testData').textContent);
        this.currentQuestionIndex = 0;
        this.answers = {};
        this.startTime = Date.now();
        this.staticMode = true; // å¯ç”¨é™æ€æ¨¡å¼ï¼Œé¿å…ä¸æ–­åˆ·æ–°
        
        this.init();
    }
    
    init() {
        this.updateTimer();
        this.displayQuestion();
        this.bindEvents();
        
        // ç¦ç”¨è®¡æ—¶å™¨è‡ªåŠ¨æ›´æ–°ï¼Œé¿å…é¡µé¢ä¸æ–­åˆ·æ–°
        // this.timerInterval = setInterval(() => this.updateTimer(), 5000); 
        // å¦‚æœéœ€è¦è®¡æ—¶å™¨ï¼Œå¯ä»¥æ‰‹åŠ¨å¯ç”¨
    }
    
    bindEvents() {
        document.getElementById('prevBtn').addEventListener('click', () => this.previousQuestion());
        document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
        document.getElementById('submitBtn').addEventListener('click', () => this.submitTest());
        
        // é”®ç›˜å¯¼èˆª
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') this.previousQuestion();
            if (e.key === 'ArrowRight') this.nextQuestion();
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                this.selectOption(optionIndex);
            }
        });
    }
    
    displayQuestion() {
        const question = this.testData.questions[this.currentQuestionIndex];
        const container = document.getElementById('questionContainer');
        
        container.innerHTML = `
            <div class="question">
                <div class="question-text">${question.question_text}</div>
                <div class="options-grid">
                    ${question.options.map((option, index) => `
                        <div class="option" data-value="${option.value}" data-index="${index}">
                            ${option.text}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        const options = container.querySelectorAll('.option');
        options.forEach((optionElement, index) => {
            optionElement.addEventListener('click', (e) => {
                e.preventDefault();
                this.selectOption(index);
            });
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            optionElement.addEventListener('touchstart', (e) => {
                e.preventDefault();
                this.selectOption(index);
            });
        });
        
        // æ›´æ–°è¿›åº¦
        this.updateProgress();
        this.updateControls();
        
        // å¦‚æœå·²æœ‰ç­”æ¡ˆï¼Œæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
        const savedAnswer = this.answers[question.id];
        if (savedAnswer) {
            options.forEach(option => {
                if (option.dataset.value === savedAnswer) {
                    option.classList.add('selected');
                }
            });
        }
    }
    
    selectOption(index) {
        const question = this.testData.questions[this.currentQuestionIndex];
        const options = document.querySelectorAll('.option');
        
        // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
        options.forEach(opt => opt.classList.remove('selected'));
        
        // é€‰ä¸­å½“å‰é€‰é¡¹
        if (options[index]) {
            options[index].classList.add('selected');
            const selectedValue = options[index].dataset.value;
            this.answers[question.id] = selectedValue;
            
            // æäº¤å½“å‰ç­”æ¡ˆåˆ°åç«¯
            this.submitAnswer(question.id, selectedValue);
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        this.updateControls();
    }
    
    async submitAnswer(questionId, answer) {
        try {
            const response = await fetch('/api/test/answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_id: this.testData.test_id,
                    question_id: questionId,
                    answer: answer
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('æäº¤ç­”æ¡ˆå¤±è´¥:', result.error);
            }
        } catch (error) {
            console.error('æäº¤ç­”æ¡ˆé”™è¯¯:', error);
        }
    }
    
    previousQuestion() {
        if (this.currentQuestionIndex > 0) {
            this.currentQuestionIndex--;
            this.displayQuestion();
        }
    }
    
    nextQuestion() {
        const currentQuestion = this.testData.questions[this.currentQuestionIndex];
        const hasAnswer = this.answers.hasOwnProperty(currentQuestion.id);
        
        // æ£€æŸ¥æ˜¯å¦å·²ç­”é¢˜
        if (!hasAnswer) {
            // æ˜¾ç¤ºæç¤º
            if (typeof WordApp !== 'undefined' && WordApp.showAlert) {
                WordApp.showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆå†ç»§ç»­', 'warning');
            } else {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆå†ç»§ç»­');
            }
            
            // é«˜äº®é€‰é¡¹åŒºåŸŸ
            const optionsGrid = document.querySelector('.options-grid');
            if (optionsGrid) {
                optionsGrid.style.border = '2px solid var(--danger-color)';
                optionsGrid.style.borderRadius = 'var(--border-radius)';
                setTimeout(() => {
                    optionsGrid.style.border = '';
                    optionsGrid.style.borderRadius = '';
                }, 2000);
            }
            return;
        }
        
        if (this.currentQuestionIndex < this.testData.questions.length - 1) {
            this.currentQuestionIndex++;
            this.displayQuestion();
        }
    }
    
    updateProgress() {
        const progress = ((this.currentQuestionIndex + 1) / this.testData.questions.length) * 100;
        const progressFill = document.getElementById('progressFill');
        
        // ç›´æ¥è®¾ç½®å®½åº¦ï¼Œå®Œå…¨ç¦ç”¨åŠ¨ç”»
        if (progressFill) {
            progressFill.style.cssText = `
                width: ${progress}% !important;
                transition: none !important;
                animation: none !important;
                transform: none !important;
            `;
        }
        
        const currentQuestionEl = document.getElementById('currentQuestion');
        if (currentQuestionEl) {
            currentQuestionEl.textContent = this.currentQuestionIndex + 1;
        }
    }
    
    updateControls() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        const currentQuestion = this.testData.questions[this.currentQuestionIndex];
        const hasAnswer = this.answers.hasOwnProperty(currentQuestion.id);
        
        // ä¸Šä¸€é¢˜æŒ‰é’®
        prevBtn.disabled = this.currentQuestionIndex === 0;
        
        if (this.currentQuestionIndex === this.testData.questions.length - 1) {
            // æœ€åä¸€é¢˜ï¼šæ˜¾ç¤ºæäº¤æŒ‰é’®
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¢˜ç›®éƒ½å·²ç­”
            const allAnswered = this.testData.questions.every(q => 
                this.answers.hasOwnProperty(q.id)
            );
            
            if (allAnswered) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤æµ‹éªŒ';
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-success');
            } else {
                const unansweredCount = this.testData.questions.length - Object.keys(this.answers).length;
                submitBtn.disabled = false;  // å…è®¸éƒ¨åˆ†å®Œæˆæ—¶æäº¤
                submitBtn.textContent = `æäº¤æµ‹éªŒ (è¿˜æœ‰${unansweredCount}é¢˜æœªç­”)`;
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-secondary');
            }
        } else {
            // éæœ€åä¸€é¢˜ï¼šæ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
            
            // ä¸‹ä¸€é¢˜æŒ‰é’®çŠ¶æ€
            if (hasAnswer) {
                nextBtn.disabled = false;
                nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
                nextBtn.classList.remove('btn-secondary');
                nextBtn.classList.add('btn-primary');
            } else {
                nextBtn.disabled = false; // ä¸ç¦ç”¨ï¼Œä½†ç‚¹å‡»æ—¶ä¼šæç¤º
                nextBtn.textContent = 'è¯·å…ˆé€‰æ‹©ç­”æ¡ˆ';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-secondary');
            }
        }
    }
    
    updateTimer() {
        if (this.staticMode) {
            // é™æ€æ¨¡å¼ä¸‹ä¸æ›´æ–°è®¡æ—¶å™¨ï¼Œé¿å…é¡µé¢åˆ·æ–°
            const timerEl = document.getElementById('timer');
            if (timerEl && !timerEl.dataset.staticSet) {
                timerEl.textContent = 'â±ï¸ 00:00';
                timerEl.dataset.staticSet = 'true';
            }
            return;
        }
        
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('timer').textContent = 
            `â±ï¸ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    async submitTest() {
        // æ¸…ç†è®¡æ—¶å™¨
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }
        
        const answeredCount = Object.keys(this.answers).length;
        const totalCount = this.testData.questions.length;
        const unansweredCount = totalCount - answeredCount;
        
        // æ£€æŸ¥æœªå®Œæˆçš„é¢˜ç›®
        if (unansweredCount > 0) {
            const message = `è¿˜æœ‰ ${unansweredCount} é“é¢˜ç›®æœªå®Œæˆï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ\n\næœªç­”çš„é¢˜ç›®å°†è¢«è®¡ä¸ºé”™è¯¯ã€‚`;
            if (!confirm(message)) {
                return;
            }
        }
        
        try {
            const response = await fetch('/api/test/finish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_id: this.testData.test_id
                })
            });
            
            const result = await response.json();
            if (result.success) {
                // è·³è½¬åˆ°ç»“æœé¡µé¢
                window.location.href = `/test/result/${this.testData.test_id}`;
            } else {
                console.error('æµ‹éªŒæäº¤å¤±è´¥:', result.error);
                alert('æäº¤æµ‹éªŒå¤±è´¥: ' + result.error);
            }
        } catch (error) {
            console.error('æäº¤æµ‹éªŒé”™è¯¯:', error);
            alert('æäº¤æµ‹éªŒæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æµ‹éªŒ
let testSession;
document.addEventListener('DOMContentLoaded', () => {
    testSession = new TestSession();
});

// é˜²æ­¢é¡µé¢åˆ·æ–°ä¸¢å¤±æ•°æ®
window.addEventListener('beforeunload', (e) => {
    // æ¸…ç†è®¡æ—¶å™¨
    if (testSession && testSession.timerInterval) {
        clearInterval(testSession.timerInterval);
    }
    e.preventDefault();
    e.returnValue = 'æµ‹éªŒæ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
});
</script>
{% endblock %}
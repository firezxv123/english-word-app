{% extends "base.html" %}

{% block title %}æµ‹éªŒä¸­å¿ƒ - {{ user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/test.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <section class="test-header">
        <div class="user-welcome">
            <h1>ğŸ“ æµ‹éªŒä¸­å¿ƒ</h1>
            <p class="welcome-text">æ£€éªŒå­¦ä¹ æˆæœï¼Œå·©å›ºè®°å¿†æ•ˆæœ</p>
            <div class="user-info-card">
                <span class="info-item">ğŸ‘¤ {{ user.username }}</span>
                <span class="info-item">ğŸ“š {{ user.grade }}å¹´çº§</span>
            </div>
        </div>
    </section>

    <section class="test-options">
        <h2 class="section-title">ğŸ“‹ æµ‹éªŒé€‰é¡¹</h2>
        
        <div class="test-grid">
            <!-- å¿«é€Ÿæµ‹éªŒ -->
            <div class="test-card">
                <div class="card-icon">âš¡</div>
                <h3 class="card-title">å¿«é€Ÿæµ‹éªŒ</h3>
                <p class="card-description">10é“é¢˜ç›®ï¼Œå¿«é€Ÿæ£€éªŒå­¦ä¹ æ•ˆæœ</p>
                
                <div class="test-config">
                    <div class="config-item">
                        <label class="config-label">æµ‹éªŒç±»å‹ï¼š</label>
                        <select id="quickTestType" class="form-select-sm">
                            <option value="cn_to_en">ä¸­è¯‘è‹±</option>
                            <option value="en_to_cn">è‹±è¯‘ä¸­</option>
                        </select>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button id="startQuickTest" class="btn btn-primary btn-block">
                        å¼€å§‹å¿«é€Ÿæµ‹éªŒ
                    </button>
                </div>
            </div>

            <!-- å•å…ƒæµ‹éªŒ -->
            <div class="test-card">
                <div class="card-icon">ğŸ“š</div>
                <h3 class="card-title">å•å…ƒæµ‹éªŒ</h3>
                <p class="card-description">é’ˆå¯¹ç‰¹å®šå•å…ƒçš„ä¸“é¡¹æµ‹éªŒ</p>
                
                <div class="test-config">
                    <div class="config-item">
                        <label class="config-label">æµ‹éªŒç±»å‹ï¼š</label>
                        <select id="unitTestType" class="form-select-sm">
                            <option value="cn_to_en">ä¸­è¯‘è‹±</option>
                            <option value="en_to_cn">è‹±è¯‘ä¸­</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label class="config-label">é€‰æ‹©å•å…ƒï¼š</label>
                        <select id="unitTestSelect" class="form-select-sm">
                            <option value="">è¯·é€‰æ‹©å•å…ƒ</option>
                            {% for unit in units %}
                            <option value="{{ unit }}">ç¬¬{{ unit }}å•å…ƒ</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="config-item">
                        <label class="config-label">é¢˜ç›®æ•°é‡ï¼š</label>
                        <select id="unitQuestionCount" class="form-select-sm">
                            <option value="10" selected>10é¢˜</option>
                            <option value="20">20é¢˜</option>
                            <option value="30">30é¢˜</option>
                        </select>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button id="startUnitTest" class="btn btn-secondary btn-block">
                        å¼€å§‹å•å…ƒæµ‹éªŒ
                    </button>
                </div>
            </div>

            <!-- ç»¼åˆæµ‹éªŒ -->
            <div class="test-card">
                <div class="card-icon">ğŸ¯</div>
                <h3 class="card-title">ç»¼åˆæµ‹éªŒ</h3>
                <p class="card-description">å…¨å¹´çº§èŒƒå›´çš„ç»¼åˆæ€§æµ‹éªŒ</p>
                
                <div class="test-config">
                    <div class="config-item">
                        <label class="config-label">æµ‹éªŒæ¨¡å¼ï¼š</label>
                        <select id="comprehensiveMode" class="form-select-sm">
                            <option value="mixed">æ··åˆæ¨¡å¼</option>
                            <option value="cn_to_en">ä»…ä¸­è¯‘è‹±</option>
                            <option value="en_to_cn">ä»…è‹±è¯‘ä¸­</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label class="config-label">é¢˜ç›®æ•°é‡ï¼š</label>
                        <select id="comprehensiveCount" class="form-select-sm">
                            <option value="20" selected>20é¢˜</option>
                            <option value="30">30é¢˜</option>
                            <option value="50">50é¢˜</option>
                        </select>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button id="startComprehensiveTest" class="btn btn-success btn-block">
                        å¼€å§‹ç»¼åˆæµ‹éªŒ
                    </button>
                </div>
            </div>

            <!-- é”™é¢˜é‡ç»ƒ -->
            <div class="test-card">
                <div class="card-icon">ğŸ”„</div>
                <h3 class="card-title">é”™é¢˜é‡ç»ƒ</h3>
                <p class="card-description">é‡æ–°æµ‹éªŒä¹‹å‰åšé”™çš„é¢˜ç›®</p>
                
                <div class="retry-info">
                    <p class="info-text">é’ˆå¯¹æ€§å¤ä¹ ï¼Œæé«˜è–„å¼±ç¯èŠ‚</p>
                </div>
                
                <div class="card-actions">
                    <button id="startRetryTest" class="btn btn-warning btn-block">
                        å¼€å§‹é”™é¢˜é‡ç»ƒ
                    </button>
                </div>
            </div>
        </div>
    </section>

    {% if recent_tests %}
    <section class="recent-tests">
        <h2 class="section-title">ğŸ“Š æœ€è¿‘æµ‹éªŒ</h2>
        
        <div class="test-history">
            {% for test in recent_tests %}
            <div class="history-item">
                <div class="test-info">
                    <div class="test-type">{{ test.test_type_name }}</div>
                    <div class="test-score score-{{ 'high' if test.score >= 80 else 'medium' if test.score >= 60 else 'low' }}">
                        {{ test.score }}%
                    </div>
                </div>
                <div class="test-details">
                    <div class="detail-item">{{ test.correct_answers }}/{{ test.total_questions }} æ­£ç¡®</div>
                    <div class="detail-item">
                        {% if test.tested_at %}
                            {{ test.tested_at.strftime('%m-%d %H:%M') if test.tested_at.__class__.__name__ == 'datetime' else test.tested_at[:16][5:] if test.tested_at else '-' }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
                <div class="test-actions">
                    {% if test.wrong_word_ids %}
                    <button class="btn btn-sm btn-outline-warning" onclick="retryTest('{{ test.id }}')">
                        é‡åšé”™é¢˜
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-info" onclick="viewResult('{{ test.id }}')">
                        æŸ¥çœ‹è¯¦æƒ…
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="history-actions">
            <a href="{{ url_for('main.test_history', user_id=user.id) }}" class="btn btn-outline-primary">
                æŸ¥çœ‹å…¨éƒ¨å†å²
            </a>
        </div>
    </section>
    {% endif %}

    {% if test_stats %}
    <section class="test-statistics">
        <h2 class="section-title">ğŸ“ˆ æµ‹éªŒç»Ÿè®¡</h2>
        
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-content">
                    <div class="stat-title">æ€»æµ‹éªŒæ¬¡æ•°</div>
                    <div class="stat-value">{{ test_stats.stats_30days.total_tests }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <div class="stat-title">å¹³å‡åˆ†æ•°</div>
                    <div class="stat-value">{{ test_stats.stats_30days.average_score }}%</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-content">
                    <div class="stat-title">æ€»ç­”é¢˜æ•°</div>
                    <div class="stat-value">{{ test_stats.stats_30days.total_questions }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <div class="stat-title">æ­£ç¡®ç‡</div>
                    <div class="stat-value">
                        {% if test_stats.stats_30days.total_questions > 0 %}
                        {{ ((test_stats.stats_30days.total_correct / test_stats.stats_30days.total_questions) * 100)|round(1) }}%
                        {% else %}0%{% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-actions">
            <a href="{{ url_for('main.test_statistics', user_id=user.id) }}" class="btn btn-outline-secondary">
                æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡
            </a>
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥å¿…è¦çš„å¯¹è±¡æ˜¯å¦å­˜åœ¨
    if (typeof ApiClient === 'undefined') {
        console.error('ApiClient æœªå®šä¹‰ï¼Œæ£€æŸ¥ api-client.js æ˜¯å¦æ­£ç¡®åŠ è½½');
        return;
    }
    
    if (typeof WordApp === 'undefined') {
        console.error('WordApp æœªå®šä¹‰ï¼Œæ£€æŸ¥ main.js æ˜¯å¦æ­£ç¡®åŠ è½½');
        return;
    }
    
    const userId = {{ user.id }};
    
    // å¿«é€Ÿæµ‹éªŒ
    const quickTestBtn = document.getElementById('startQuickTest');
    if (quickTestBtn) {
        quickTestBtn.addEventListener('click', function() {
            const testType = document.getElementById('quickTestType').value;
            startTest(testType, null, 10);
        });
    } else {
        console.error('å¿«é€Ÿæµ‹éªŒæŒ‰é’®æœªæ‰¾åˆ°');
    }
    
    // å•å…ƒæµ‹éªŒ
    const unitTestBtn = document.getElementById('startUnitTest');
    if (unitTestBtn) {
        unitTestBtn.addEventListener('click', function() {
            const testType = document.getElementById('unitTestType').value;
            const unit = document.getElementById('unitTestSelect').value;
            const count = document.getElementById('unitQuestionCount').value;
            
            if (!unit) {
                const errorMsg = 'è¯·é€‰æ‹©æµ‹éªŒå•å…ƒ';
                if (typeof WordApp !== 'undefined' && WordApp.showAlert) {
                    WordApp.showAlert(errorMsg, 'warning');
                } else {
                    alert(errorMsg);
                }
                return;
            }
            
            startTest(testType, parseInt(unit) || null, parseInt(count) || 10);
        });
    } else {
        console.error('å•å…ƒæµ‹éªŒæŒ‰é’®æœªæ‰¾åˆ°');
    }
    
    // ç»¼åˆæµ‹éªŒ
    const comprehensiveTestBtn = document.getElementById('startComprehensiveTest');
    if (comprehensiveTestBtn) {
        comprehensiveTestBtn.addEventListener('click', function() {
            const mode = document.getElementById('comprehensiveMode').value;
            const count = document.getElementById('comprehensiveCount').value;
            
            const testType = mode === 'mixed' ? 'cn_to_en' : mode;
            startTest(testType, null, parseInt(count));
        });
    } else {
        console.error('ç»¼åˆæµ‹éªŒæŒ‰é’®æœªæ‰¾åˆ°');
    }
    
    // é”™é¢˜é‡ç»ƒ
    const retryTestBtn = document.getElementById('startRetryTest');
    if (retryTestBtn) {
        retryTestBtn.addEventListener('click', function() {
            // è¿™é‡Œéœ€è¦è·å–æœ€è¿‘çš„é”™é¢˜æµ‹éªŒID
            const message = 'åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…';
            if (typeof WordApp !== 'undefined' && WordApp.showAlert) {
                WordApp.showAlert(message, 'info');
            } else {
                alert(message);
            }
        });
    } else {
        console.error('é”™é¢˜é‡ç»ƒæŒ‰é’®æœªæ‰¾åˆ°');
    }
});

async function startTest(testType, unit, questionCount) {
    try {
        // æ£€æŸ¥ API å®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
        if (typeof ApiClient === 'undefined') {
            console.error('ApiClient æœªå®šä¹‰');
            alert('ç³»ç»Ÿé”™è¯¯ï¼šAPIå®¢æˆ·ç«¯æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        // æ£€æŸ¥ WordApp æ˜¯å¦å¯ç”¨
        if (typeof WordApp === 'undefined') {
            console.error('WordApp æœªå®šä¹‰');
            alert('ç³»ç»Ÿé”™è¯¯ï¼šåº”ç”¨å¯¹è±¡æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        // å®‰å…¨å¤„ç†å‚æ•°
        const safeUnit = (unit && unit !== '') ? parseInt(unit) : null;
        const safeQuestionCount = questionCount && questionCount > 0 ? parseInt(questionCount) : 10;
        
        const response = await ApiClient.test.generate(
            {{ user.id }}, 
            testType, 
            {{ user.grade }}, 
            safeUnit, 
            safeQuestionCount
        );
        
        if (response.success) {
            // è·³è½¬åˆ°æµ‹éªŒé¡µé¢
            window.location.href = `/test/session/${response.data.test_id}`;
        } else {
            const errorMsg = response.error || 'åˆ›å»ºæµ‹éªŒå¤±è´¥';
            console.error('æµ‹éªŒåˆ›å»ºå¤±è´¥:', errorMsg);
            if (typeof WordApp !== 'undefined' && WordApp.showAlert) {
                WordApp.showAlert(errorMsg, 'error');
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('åˆ›å»ºæµ‹éªŒå¤±è´¥:', error);
        const errorMsg = 'åˆ›å»ºæµ‹éªŒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        if (typeof WordApp !== 'undefined' && WordApp.showAlert) {
            WordApp.showAlert(errorMsg, 'error');
        } else {
            alert(errorMsg);
        }
    }
}

function retryTest(testId) {
    // é‡åšé”™é¢˜
    window.location.href = `/test/{{ user.id }}/retry/${testId}`;
}

function viewResult(testId) {
    // æŸ¥çœ‹æµ‹éªŒç»“æœ
    window.location.href = `/test/result/${testId}`;
}
</script>
{% endblock %}
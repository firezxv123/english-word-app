{% extends "base.html" %}

{% block title %}ç³»ç»Ÿæ—¥å¿— - å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨{% endblock %}

{% block extra_css %}
<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-lg);
}

.admin-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-xl) 0;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: var(--white);
    border-radius: var(--border-radius-lg);
}

.admin-header h1 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-xxl);
}

.log-controls {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
}

.control-row {
    display: flex;
    gap: var(--spacing-md);
    align-items: end;
    flex-wrap: wrap;
    margin-bottom: var(--spacing-md);
}

.control-row .form-group {
    flex: 1;
    min-width: 150px;
}

.log-viewer {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.log-header {
    background: var(--gray-100);
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.log-content {
    height: 600px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.4;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: var(--spacing-md);
}

.log-line {
    margin-bottom: 2px;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.log-line.error {
    color: #ff6b6b;
}

.log-line.warning {
    color: #ffd93d;
}

.log-line.info {
    color: #74c0fc;
}

.log-line.debug {
    color: #51cf66;
}

.log-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.stat-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    text-align: center;
}

.stat-value {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-color);
    margin-bottom: var(--spacing-xs);
}

.stat-label {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.loading {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .control-row {
        flex-direction: column;
    }
    
    .control-row .form-group {
        min-width: auto;
    }
    
    .log-header {
        flex-direction: column;
        gap: var(--spacing-sm);
        align-items: stretch;
    }
    
    .log-content {
        height: 400px;
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <section class="admin-header">
        <h1>ğŸ” ç³»ç»Ÿæ—¥å¿—</h1>
        <p>æŸ¥çœ‹å’Œç®¡ç†åº”ç”¨ç³»ç»Ÿæ—¥å¿—</p>
    </section>

    <!-- æ—¥å¿—ç»Ÿè®¡ -->
    <section class="log-stats">
        <div class="stat-card">
            <div class="stat-value" id="totalLines">-</div>
            <div class="stat-label">æ€»æ—¥å¿—è¡Œæ•°</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value" id="errorCount">-</div>
            <div class="stat-label">é”™è¯¯æ•°é‡</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value" id="warningCount">-</div>
            <div class="stat-label">è­¦å‘Šæ•°é‡</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value" id="lastUpdate">-</div>
            <div class="stat-label">æœ€åæ›´æ–°</div>
        </div>
    </section>

    <!-- æ—¥å¿—æ§åˆ¶ -->
    <section class="log-controls">
        <div class="control-row">
            <div class="form-group">
                <label for="logLevel" class="form-label">æ—¥å¿—çº§åˆ«ï¼š</label>
                <select id="logLevel" class="form-select">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="error">é”™è¯¯</option>
                    <option value="warning">è­¦å‘Š</option>
                    <option value="info">ä¿¡æ¯</option>
                    <option value="debug">è°ƒè¯•</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="logLines" class="form-label">æ˜¾ç¤ºè¡Œæ•°ï¼š</label>
                <select id="logLines" class="form-select">
                    <option value="50">50è¡Œ</option>
                    <option value="100" selected>100è¡Œ</option>
                    <option value="200">200è¡Œ</option>
                    <option value="500">500è¡Œ</option>
                    <option value="1000">1000è¡Œ</option>
                </select>
            </div>
            
            <div class="form-group">
                <button id="refreshLogs" class="btn btn-primary">
                    ğŸ”„ åˆ·æ–°æ—¥å¿—
                </button>
                <button id="clearLogs" class="btn btn-warning">
                    ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                </button>
                <button id="downloadLogs" class="btn btn-secondary">
                    ğŸ“¥ ä¸‹è½½æ—¥å¿—
                </button>
            </div>
        </div>
        
        <div class="control-row">
            <label>
                <input type="checkbox" id="autoRefresh"> è‡ªåŠ¨åˆ·æ–° (æ¯30ç§’)
            </label>
        </div>
    </section>

    <!-- æ—¥å¿—æŸ¥çœ‹å™¨ -->
    <section class="log-viewer">
        <div class="log-header">
            <h3>æ—¥å¿—å†…å®¹</h3>
            <span id="logStatus">å‡†å¤‡å°±ç»ª</span>
        </div>
        <div class="log-content" id="logContent">
            <div class="loading">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const logContent = document.getElementById('logContent');
    const logLevel = document.getElementById('logLevel');
    const logLines = document.getElementById('logLines');
    const refreshBtn = document.getElementById('refreshLogs');
    const clearBtn = document.getElementById('clearLogs');
    const downloadBtn = document.getElementById('downloadLogs');
    const autoRefreshCheck = document.getElementById('autoRefresh');
    const logStatus = document.getElementById('logStatus');
    
    let autoRefreshInterval = null;
    
    // åŠ è½½æ—¥å¿—
    function loadLogs() {
        const level = logLevel.value;
        const lines = logLines.value;
        
        logStatus.textContent = 'åŠ è½½ä¸­...';
        
        fetch(`/admin/logs/api?level=${level}&lines=${lines}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLogs(data.data);
                    updateStats(data.data);
                    logStatus.textContent = `å·²åŠ è½½ ${data.count} è¡Œæ—¥å¿—`;
                } else {
                    logContent.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${data.error}</div>`;
                    logStatus.textContent = 'åŠ è½½å¤±è´¥';
                }
            })
            .catch(error => {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                logContent.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                logStatus.textContent = 'åŠ è½½å¤±è´¥';
            });
    }
    
    // æ˜¾ç¤ºæ—¥å¿—
    function displayLogs(logs) {
        if (logs.length === 0) {
            logContent.innerHTML = '<div class="loading">æš‚æ— æ—¥å¿—æ•°æ®</div>';
            return;
        }
        
        const html = logs.map(log => {
            let className = 'log-line';
            
            if (log.includes('ERROR')) {
                className += ' error';
            } else if (log.includes('WARNING')) {
                className += ' warning';
            } else if (log.includes('INFO')) {
                className += ' info';
            } else if (log.includes('DEBUG')) {
                className += ' debug';
            }
            
            return `<div class="${className}">${escapeHtml(log)}</div>`;
        }).join('');
        
        logContent.innerHTML = html;
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        logContent.scrollTop = logContent.scrollHeight;
    }
    
    // æ›´æ–°ç»Ÿè®¡
    function updateStats(logs) {
        const totalLines = logs.length;
        const errorCount = logs.filter(log => log.includes('ERROR')).length;
        const warningCount = logs.filter(log => log.includes('WARNING')).length;
        const lastUpdate = new Date().toLocaleString();
        
        document.getElementById('totalLines').textContent = totalLines;
        document.getElementById('errorCount').textContent = errorCount;
        document.getElementById('warningCount').textContent = warningCount;
        document.getElementById('lastUpdate').textContent = lastUpdate;
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
        }
        
        fetch('/admin/logs/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ—¥å¿—å·²æ¸…ç©º');
                    loadLogs();
                } else {
                    alert('æ¸…ç©ºå¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
            });
    }
    
    // ä¸‹è½½æ—¥å¿—
    function downloadLogs() {
        window.location.href = '/admin/logs/download';
    }
    
    // è‡ªåŠ¨åˆ·æ–°
    function toggleAutoRefresh() {
        if (autoRefreshCheck.checked) {
            autoRefreshInterval = setInterval(loadLogs, 30000);
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }
    
    // äº‹ä»¶ç›‘å¬
    refreshBtn.addEventListener('click', loadLogs);
    clearBtn.addEventListener('click', clearLogs);
    downloadBtn.addEventListener('click', downloadLogs);
    autoRefreshCheck.addEventListener('change', toggleAutoRefresh);
    
    logLevel.addEventListener('change', loadLogs);
    logLines.addEventListener('change', loadLogs);
    
    // åˆå§‹åŠ è½½
    loadLogs();
});
</script>
{% endblock %}
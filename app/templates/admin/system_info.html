{% extends "base.html" %}

{% block title %}ç³»ç»Ÿä¿¡æ¯ - å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨{% endblock %}

{% block extra_css %}
<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-lg);
}

.admin-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-xl) 0;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: var(--white);
    border-radius: var(--border-radius-lg);
}

.admin-header h1 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-xxl);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-lg);
}

.info-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
}

.info-card h3 {
    margin: 0 0 var(--spacing-md) 0;
    color: var(--primary-color);
    font-size: var(--font-size-lg);
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--gray-200);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
}

.info-value {
    color: var(--text-secondary);
    text-align: right;
    word-break: break-all;
    max-width: 60%;
}

.admin-actions {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    margin-top: var(--spacing-lg);
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
}

.error-message {
    background: var(--danger-light);
    color: var(--danger-color);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    margin-bottom: var(--spacing-lg);
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <section class="admin-header">
        <h1>âš™ï¸ ç³»ç»Ÿä¿¡æ¯</h1>
        <p>æŸ¥çœ‹åº”ç”¨ç³»ç»ŸçŠ¶æ€å’Œé…ç½®ä¿¡æ¯</p>
    </section>

    {% if error %}
    <div class="error-message">
        <strong>é”™è¯¯ï¼š</strong>{{ error }}
    </div>
    {% endif %}

    <div class="info-grid">
        <!-- åº”ç”¨ä¿¡æ¯ -->
        <div class="info-card">
            <h3>ğŸ“± åº”ç”¨ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">åº”ç”¨åç§°</span>
                <span class="info-value">å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç‰ˆæœ¬</span>
                <span class="info-value">v1.0.0</span>
            </div>
            <div class="info-item">
                <span class="info-label">å¯åŠ¨æ—¶é—´</span>
                <span class="info-value">{{ system_info.get('start_time', 'æœªçŸ¥') }}</span>
            </div>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="info-card">
            <h3>ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">æ“ä½œç³»ç»Ÿ</span>
                <span class="info-value">{{ system_info.get('platform', 'æœªçŸ¥') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Pythonç‰ˆæœ¬</span>
                <span class="info-value">{{ system_info.get('python_version', 'æœªçŸ¥').split()[0] if system_info.get('python_version') else 'æœªçŸ¥' }}</span>
            </div>
        </div>

        <!-- æ•°æ®åº“ä¿¡æ¯ -->
        <div class="info-card">
            <h3>ğŸ—„ï¸ æ•°æ®åº“ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">å•è¯æ€»æ•°</span>
                <span class="info-value">{{ system_info.get('word_count', 0) }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç”¨æˆ·æ€»æ•°</span>
                <span class="info-value">{{ system_info.get('user_count', 0) }}</span>
            </div>
        </div>

        <!-- ç¼“å­˜ä¿¡æ¯ -->
        <div class="info-card">
            <h3>ğŸ’¾ ç¼“å­˜ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">ç¼“å­˜é¡¹ç›®æ•°</span>
                <span class="info-value" id="cacheItemCount">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">å†…å­˜ä½¿ç”¨é‡</span>
                <span class="info-value" id="cacheMemoryUsage">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç¼“å­˜å‘½ä¸­ç‡</span>
                <span class="info-value" id="cacheHitRate">-</span>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†æ“ä½œ -->
    <section class="admin-actions">
        <h3>ğŸ”§ ç®¡ç†æ“ä½œ</h3>
        <div class="action-grid">
            <a href="{{ url_for('main.admin_logs') }}" class="btn btn-primary">
                ğŸ” æŸ¥çœ‹æ—¥å¿—
            </a>
            <a href="{{ url_for('main.word_list') }}" class="btn btn-secondary">
                ğŸ“š è¯åº“ç®¡ç†
            </a>
            <button id="batchGenerateAudio" class="btn btn-info">
                ğŸ”Š æ‰¹é‡ç”ŸæˆéŸ³é¢‘
            </button>
            <button id="validateAudio" class="btn btn-warning">
                âœ… éªŒè¯éŸ³é¢‘æ–‡ä»¶
            </button>
            <button id="warmupCache" class="btn btn-success">
                ğŸ”¥ ç¼“å­˜é¢„çƒ­
            </button>
            <button id="clearCache" class="btn btn-danger">
                ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜
            </button>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const batchGenerateAudioBtn = document.getElementById('batchGenerateAudio');
    const validateAudioBtn = document.getElementById('validateAudio');
    const warmupCacheBtn = document.getElementById('warmupCache');
    const clearCacheBtn = document.getElementById('clearCache');
    
    // åŠ è½½ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
    loadCacheStats();
    
    function loadCacheStats() {
        fetch('/api/cache/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.data.cache_stats;
                document.getElementById('cacheItemCount').textContent = stats.total_items || 0;
                document.getElementById('cacheMemoryUsage').textContent = 
                    (stats.memory_usage ? (stats.memory_usage / 1024).toFixed(2) + ' KB' : '0 KB');
                document.getElementById('cacheHitRate').textContent = 
                    (stats.hit_rate ? stats.hit_rate.toFixed(1) + '%' : '0%');
            }
        })
        .catch(error => {
            console.error('è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥:', error);
        });
    }
    
    // æ‰¹é‡ç”ŸæˆéŸ³é¢‘
    batchGenerateAudioBtn.addEventListener('click', function() {
        if (!confirm('ç¡®å®šè¦ä¸ºæ‰€æœ‰å•è¯æ‰¹é‡ç”ŸæˆéŸ³é¢‘å—ï¼Ÿè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚')) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'â³ ç”Ÿæˆä¸­...';
        
        fetch('/api/words/audio/batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const results = data.data;
                alert(`éŸ³é¢‘ç”Ÿæˆå®Œæˆï¼æˆåŠŸ: ${results.success_count}, å¤±è´¥: ${results.error_count}`);
            } else {
                alert('éŸ³é¢‘ç”Ÿæˆå¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('éŸ³é¢‘ç”Ÿæˆå¤±è´¥: ' + error.message);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'ğŸ”Š æ‰¹é‡ç”ŸæˆéŸ³é¢‘';
        });
    });
    
    // éªŒè¯éŸ³é¢‘æ–‡ä»¶
    validateAudioBtn.addEventListener('click', function() {
        this.disabled = true;
        this.textContent = 'â³ éªŒè¯ä¸­...';
        
        fetch('/api/words/audio/validate')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const results = data.data;
                alert(`éªŒè¯å®Œæˆï¼æœ‰æ•ˆ: ${results.valid_count}, æ— æ•ˆ: ${results.invalid_count}`);
            } else {
                alert('éªŒè¯å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('éªŒè¯å¤±è´¥: ' + error.message);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'âœ… éªŒè¯éŸ³é¢‘æ–‡ä»¶';
        });
    // ç¼“å­˜é¢„çƒ­
    warmupCacheBtn.addEventListener('click', function() {
        this.disabled = true;
        this.textContent = 'â³ é¢„çƒ­ä¸­...';
        
        fetch('/api/cache/warmup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ types: ['words', 'users'] })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ç¼“å­˜é¢„çƒ­å®Œæˆï¼é¢„çƒ­é¡¹ç›®æ•°: ' + data.data.count);
                loadCacheStats(); // é‡æ–°åŠ è½½ç¼“å­˜ç»Ÿè®¡
            } else {
                alert('ç¼“å­˜é¢„çƒ­å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('ç¼“å­˜é¢„çƒ­å¤±è´¥: ' + error.message);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'ğŸ”¥ ç¼“å­˜é¢„çƒ­';
        });
    });
    
    // æ¸…é™¤ç¼“å­˜
    clearCacheBtn.addEventListener('click', function() {
        if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'â³ æ¸…é™¤ä¸­...';
        
        fetch('/api/cache/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ type: 'all' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ç¼“å­˜æ¸…é™¤å®Œæˆï¼');
                loadCacheStats(); // é‡æ–°åŠ è½½ç¼“å­˜ç»Ÿè®¡
            } else {
                alert('ç¼“å­˜æ¸…é™¤å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('ç¼“å­˜æ¸…é™¤å¤±è´¥: ' + error.message);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜';
        });
    });
</script>
{% endblock %}
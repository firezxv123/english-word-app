{% extends "base.html" %}

{% block title %}词库管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>📚 词库管理</h2>
            <p class="text-muted">管理小学英语词库数据</p>
        </div>
    </div>

    <!-- 词库统计 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>📊 词库统计</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-primary">{{ total_words }}</h3>
                                <p class="text-muted">总词汇数</p>
                            </div>
                        </div>
                        {% for grade, count in stats.items() %}
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4>{{ count }}</h4>
                                <p class="text-muted">{{ grade }}年级</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>🛠️ 词库操作</h5>
                </div>
                <div class="card-body">
                    <button id="importBtn" class="btn btn-primary me-2">
                        <i class="fas fa-upload"></i> 导入人教版词库
                    </button>
                    <button id="importGrade6Btn" class="btn btn-success me-2">
                        <i class="fas fa-star"></i> 补充六年级词库
                    </button>
                    <button id="checkBtn" class="btn btn-info me-2">
                        <i class="fas fa-check"></i> 检查词库完整性
                    </button>
                    <button id="refreshBtn" class="btn btn-secondary">
                        <i class="fas fa-refresh"></i> 刷新统计
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果显示区域 -->
    <div class="row">
        <div class="col-md-12">
            <div id="results" class="card" style="display: none;">
                <div class="card-header">
                    <h5>📋 操作结果</h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    border-radius: 8px;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.btn {
    border-radius: 6px;
}

.progress {
    height: 20px;
}

.alert {
    border-radius: 6px;
}

.badge {
    font-size: 0.8rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.getElementById('importBtn');
    const importGrade6Btn = document.getElementById('importGrade6Btn');
    const checkBtn = document.getElementById('checkBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const results = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');

    function showResults(content) {
        resultsContent.innerHTML = content;
        results.style.display = 'block';
        results.scrollIntoView({ behavior: 'smooth' });
    }

    function showLoading(message) {
        showResults(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">${message}</p>
            </div>
        `);
    }

    importBtn.addEventListener('click', async function() {
        showLoading('正在导入词库数据...');
        
        try {
            const response = await fetch('/admin/words/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ${data.message}</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>文件</th>
                                    <th>导入数量</th>
                                    <th>总数量</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.results.forEach(result => {
                    if (result.error) {
                        html += `
                            <tr>
                                <td>${result.file}</td>
                                <td colspan="2">-</td>
                                <td><span class="badge bg-danger">${result.error}</span></td>
                            </tr>
                        `;
                    } else {
                        html += `
                            <tr>
                                <td>${result.file}</td>
                                <td>${result.imported}</td>
                                <td>${result.total}</td>
                                <td><span class="badge bg-success">成功</span></td>
                            </tr>
                        `;
                    }
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                showResults(html);
                
                // 3秒后自动刷新页面
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
                
            } else {
                showResults(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> 导入失败</h6>
                        <p>${data.error}</p>
                    </div>
                `);
            }
        } catch (error) {
            showResults(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> 请求失败</h6>
                    <p>${error.message}</p>
                </div>
            `);
        }
    });

    // 6年级词库补充按钮事件
    importGrade6Btn.addEventListener('click', async function() {
        if (!confirm('将补充完整的六年级词库，包含2024年人教版PEP教材的所有核心词汇。\n这将解决您提到的"6年级词库还缺少很多"的问题。\n\n确定要继续吗？')) {
            return;
        }
        
        showLoading('正在补充六年级词库...');
        
        try {
            const response = await fetch('/admin/words/import_grade6', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ${data.message}</h6>
                        <div class="mt-3">
                            <strong>📊 统计信息:</strong><br>
                            • 补充前: ${data.before_count} 个词汇<br>
                            • 补充后: ${data.after_count} 个词汇<br>
                            • 增长: ${data.after_count - data.before_count} 个词汇
                        </div>
                        <div class="mt-3">
                            <strong>📚 词库来源:</strong><br>
                            ${data.source_info.description}<br>
                            • 包含主题: ${data.source_info.includes.join('、')}<br>
                            • 涵盖单元: 共${data.source_info.total_units}个单元
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <h6>💡 关于您的问题 "词库来源是哪里？6年级的词库还缺少很多":</h6>
                        <ul class="mb-0">
                            <li><strong>词库来源:</strong> 2024年最新人教版PEP小学英语六年级教材官方词汇表</li>
                            <li><strong>补充标准:</strong> 教育部《义务教育英语课程标准(2022年版)》</li>
                            <li><strong>现在状态:</strong> 六年级词库已大幅补充，从基础版本的70个词汇增加到${data.after_count}个</li>
                            <li><strong>覆盖内容:</strong> 包含六年级上下册完整的核心词汇和重点表达</li>
                        </ul>
                    </div>
                `;
                
                showResults(html);
                
                // 5秒后自动刷新页面
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
                
            } else {
                showResults(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> 六年级词库补充失败</h6>
                        <p>${data.error}</p>
                    </div>
                `);
            }
        } catch (error) {
            showResults(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> 请求失败</h6>
                    <p>${error.message}</p>
                </div>
            `);
        }
    });

    checkBtn.addEventListener('click', async function() {
        showLoading('正在检查词库完整性...');
        
        try {
            const response = await fetch('/admin/words/check');
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> 词库完整性检查结果</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>年级</th>
                                    <th>当前数量</th>
                                    <th>标准要求</th>
                                    <th>完成度</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.results.forEach(result => {
                    const statusBadge = result.status === 'complete' 
                        ? '<span class="badge bg-success">完成</span>'
                        : '<span class="badge bg-warning">不足</span>';
                    
                    html += `
                        <tr>
                            <td>${result.grade}年级</td>
                            <td>${result.actual}</td>
                            <td>${result.required}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar ${result.status === 'complete' ? 'bg-success' : 'bg-warning'}" 
                                         style="width: ${Math.min(result.percentage, 100)}%">
                                        ${result.percentage}%
                                    </div>
                                </div>
                            </td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                showResults(html);
            } else {
                showResults(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> 检查失败</h6>
                        <p>${data.error}</p>
                    </div>
                `);
            }
        } catch (error) {
            showResults(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> 请求失败</h6>
                    <p>${error.message}</p>
                </div>
            `);
        }
    });

    refreshBtn.addEventListener('click', function() {
        window.location.reload();
    });
});
</script>
{% endblock %}
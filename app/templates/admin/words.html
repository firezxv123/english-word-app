{% extends "base.html" %}

{% block title %}è¯åº“ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>ğŸ“š è¯åº“ç®¡ç†</h2>
            <p class="text-muted">ç®¡ç†å°å­¦è‹±è¯­è¯åº“æ•°æ®</p>
        </div>
    </div>

    <!-- è¯åº“ç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š è¯åº“ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-primary">{{ total_words }}</h3>
                                <p class="text-muted">æ€»è¯æ±‡æ•°</p>
                            </div>
                        </div>
                        {% for grade, count in stats.items() %}
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4>{{ count }}</h4>
                                <p class="text-muted">{{ grade }}å¹´çº§</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ› ï¸ è¯åº“æ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <button id="importBtn" class="btn btn-primary me-2">
                        <i class="fas fa-upload"></i> å¯¼å…¥äººæ•™ç‰ˆè¯åº“
                    </button>
                    <button id="importGrade6Btn" class="btn btn-success me-2">
                        <i class="fas fa-star"></i> è¡¥å……å…­å¹´çº§è¯åº“
                    </button>
                    <button id="checkBtn" class="btn btn-info me-2">
                        <i class="fas fa-check"></i> æ£€æŸ¥è¯åº“å®Œæ•´æ€§
                    </button>
                    <button id="refreshBtn" class="btn btn-secondary">
                        <i class="fas fa-refresh"></i> åˆ·æ–°ç»Ÿè®¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="row">
        <div class="col-md-12">
            <div id="results" class="card" style="display: none;">
                <div class="card-header">
                    <h5>ğŸ“‹ æ“ä½œç»“æœ</h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    border-radius: 8px;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.btn {
    border-radius: 6px;
}

.progress {
    height: 20px;
}

.alert {
    border-radius: 6px;
}

.badge {
    font-size: 0.8rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.getElementById('importBtn');
    const importGrade6Btn = document.getElementById('importGrade6Btn');
    const checkBtn = document.getElementById('checkBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const results = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');

    function showResults(content) {
        resultsContent.innerHTML = content;
        results.style.display = 'block';
        results.scrollIntoView({ behavior: 'smooth' });
    }

    function showLoading(message) {
        showResults(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">${message}</p>
            </div>
        `);
    }

    importBtn.addEventListener('click', async function() {
        showLoading('æ­£åœ¨å¯¼å…¥è¯åº“æ•°æ®...');
        
        try {
            const response = await fetch('/admin/words/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ${data.message}</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>æ–‡ä»¶</th>
                                    <th>å¯¼å…¥æ•°é‡</th>
                                    <th>æ€»æ•°é‡</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.results.forEach(result => {
                    if (result.error) {
                        html += `
                            <tr>
                                <td>${result.file}</td>
                                <td colspan="2">-</td>
                                <td><span class="badge bg-danger">${result.error}</span></td>
                            </tr>
                        `;
                    } else {
                        html += `
                            <tr>
                                <td>${result.file}</td>
                                <td>${result.imported}</td>
                                <td>${result.total}</td>
                                <td><span class="badge bg-success">æˆåŠŸ</span></td>
                            </tr>
                        `;
                    }
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                showResults(html);
                
                // 3ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
                
            } else {
                showResults(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> å¯¼å…¥å¤±è´¥</h6>
                        <p>${data.error}</p>
                    </div>
                `);
            }
        } catch (error) {
            showResults(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> è¯·æ±‚å¤±è´¥</h6>
                    <p>${error.message}</p>
                </div>
            `);
        }
    });

    // 6å¹´çº§è¯åº“è¡¥å……æŒ‰é’®äº‹ä»¶
    importGrade6Btn.addEventListener('click', async function() {
        if (!confirm('å°†è¡¥å……å®Œæ•´çš„å…­å¹´çº§è¯åº“ï¼ŒåŒ…å«2024å¹´äººæ•™ç‰ˆPEPæ•™æçš„æ‰€æœ‰æ ¸å¿ƒè¯æ±‡ã€‚\nè¿™å°†è§£å†³æ‚¨æåˆ°çš„"6å¹´çº§è¯åº“è¿˜ç¼ºå°‘å¾ˆå¤š"çš„é—®é¢˜ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            return;
        }
        
        showLoading('æ­£åœ¨è¡¥å……å…­å¹´çº§è¯åº“...');
        
        try {
            const response = await fetch('/admin/words/import_grade6', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ${data.message}</h6>
                        <div class="mt-3">
                            <strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:</strong><br>
                            â€¢ è¡¥å……å‰: ${data.before_count} ä¸ªè¯æ±‡<br>
                            â€¢ è¡¥å……å: ${data.after_count} ä¸ªè¯æ±‡<br>
                            â€¢ å¢é•¿: ${data.after_count - data.before_count} ä¸ªè¯æ±‡
                        </div>
                        <div class="mt-3">
                            <strong>ğŸ“š è¯åº“æ¥æº:</strong><br>
                            ${data.source_info.description}<br>
                            â€¢ åŒ…å«ä¸»é¢˜: ${data.source_info.includes.join('ã€')}<br>
                            â€¢ æ¶µç›–å•å…ƒ: å…±${data.source_info.total_units}ä¸ªå•å…ƒ
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <h6>ğŸ’¡ å…³äºæ‚¨çš„é—®é¢˜ "è¯åº“æ¥æºæ˜¯å“ªé‡Œï¼Ÿ6å¹´çº§çš„è¯åº“è¿˜ç¼ºå°‘å¾ˆå¤š":</h6>
                        <ul class="mb-0">
                            <li><strong>è¯åº“æ¥æº:</strong> 2024å¹´æœ€æ–°äººæ•™ç‰ˆPEPå°å­¦è‹±è¯­å…­å¹´çº§æ•™æå®˜æ–¹è¯æ±‡è¡¨</li>
                            <li><strong>è¡¥å……æ ‡å‡†:</strong> æ•™è‚²éƒ¨ã€Šä¹‰åŠ¡æ•™è‚²è‹±è¯­è¯¾ç¨‹æ ‡å‡†(2022å¹´ç‰ˆ)ã€‹</li>
                            <li><strong>ç°åœ¨çŠ¶æ€:</strong> å…­å¹´çº§è¯åº“å·²å¤§å¹…è¡¥å……ï¼Œä»åŸºç¡€ç‰ˆæœ¬çš„70ä¸ªè¯æ±‡å¢åŠ åˆ°${data.after_count}ä¸ª</li>
                            <li><strong>è¦†ç›–å†…å®¹:</strong> åŒ…å«å…­å¹´çº§ä¸Šä¸‹å†Œå®Œæ•´çš„æ ¸å¿ƒè¯æ±‡å’Œé‡ç‚¹è¡¨è¾¾</li>
                        </ul>
                    </div>
                `;
                
                showResults(html);
                
                // 5ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
                
            } else {
                showResults(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> å…­å¹´çº§è¯åº“è¡¥å……å¤±è´¥</h6>
                        <p>${data.error}</p>
                    </div>
                `);
            }
        } catch (error) {
            showResults(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> è¯·æ±‚å¤±è´¥</h6>
                    <p>${error.message}</p>
                </div>
            `);
        }
    });

    checkBtn.addEventListener('click', async function() {
        showLoading('æ­£åœ¨æ£€æŸ¥è¯åº“å®Œæ•´æ€§...');
        
        try {
            const response = await fetch('/admin/words/check');
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> è¯åº“å®Œæ•´æ€§æ£€æŸ¥ç»“æœ</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å¹´çº§</th>
                                    <th>å½“å‰æ•°é‡</th>
                                    <th>æ ‡å‡†è¦æ±‚</th>
                                    <th>å®Œæˆåº¦</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.results.forEach(result => {
                    const statusBadge = result.status === 'complete' 
                        ? '<span class="badge bg-success">å®Œæˆ</span>'
                        : '<span class="badge bg-warning">ä¸è¶³</span>';
                    
                    html += `
                        <tr>
                            <td>${result.grade}å¹´çº§</td>
                            <td>${result.actual}</td>
                            <td>${result.required}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar ${result.status === 'complete' ? 'bg-success' : 'bg-warning'}" 
                                         style="width: ${Math.min(result.percentage, 100)}%">
                                        ${result.percentage}%
                                    </div>
                                </div>
                            </td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                showResults(html);
            } else {
                showResults(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-circle"></i> æ£€æŸ¥å¤±è´¥</h6>
                        <p>${data.error}</p>
                    </div>
                `);
            }
        } catch (error) {
            showResults(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> è¯·æ±‚å¤±è´¥</h6>
                    <p>${error.message}</p>
                </div>
            `);
        }
    });

    refreshBtn.addEventListener('click', function() {
        window.location.reload();
    });
});
</script>
{% endblock %}
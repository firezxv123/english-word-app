{% extends "base.html" %}

{% block title %}学习中心 - {{ user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/study.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <section class="study-header">
        <div class="user-welcome">
            <h1>🎓 学习中心</h1>
            <p class="welcome-text">欢迎，{{ user.username }}！开始您的英语学习之旅吧</p>
            <div class="user-info-card">
                <span class="info-item">📚 {{ user.grade }}年级</span>
                <span class="info-item">📖 当前单元：第{{ user.current_unit }}单元</span>
            </div>
        </div>
    </section>

    <section class="study-options">
        <h2 class="section-title">📖 学习选项</h2>
        
        <div class="study-grid">
            <!-- 按单元学习 -->
            <div class="study-card">
                <div class="card-icon">📚</div>
                <h3 class="card-title">按单元学习</h3>
                <p class="card-description">选择特定单元进行系统化学习</p>
                
                <div class="unit-selector">
                    <label for="unitSelect" class="form-label">选择单元：</label>
                    <select id="unitSelect" class="form-select">
                        <option value="">请选择单元</option>
                        {% for unit in units %}
                        <option value="{{ unit }}" {% if unit == user.current_unit %}selected{% endif %}>
                            第{{ unit }}单元
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="card-actions">
                    <button id="startUnitStudy" class="btn btn-primary btn-block">
                        开始单元学习
                    </button>
                </div>
            </div>

            <!-- 智能复习 -->
            <div class="study-card">
                <div class="card-icon">🧠</div>
                <h3 class="card-title">智能复习</h3>
                <p class="card-description">系统推荐需要复习的单词</p>
                
                {% if recommended_words %}
                <div class="preview-words">
                    <p class="preview-label">推荐复习：</p>
                    <div class="word-tags">
                        {% for word in recommended_words %}
                        <span class="word-tag">{{ word.word }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="card-actions">
                    <a href="{{ url_for('main.study_review', user_id=user.id) }}" class="btn btn-secondary btn-block">
                        开始智能复习
                    </a>
                </div>
            </div>

            <!-- 全年级学习 -->
            <div class="study-card">
                <div class="card-icon">🌟</div>
                <h3 class="card-title">全年级学习</h3>
                <p class="card-description">学习{{ user.grade }}年级所有单词</p>
                
                <div class="grade-info">
                    <p class="info-text">包含{{ user.grade }}年级全部单元内容</p>
                </div>
                
                <div class="card-actions">
                    <button id="startGradeStudy" class="btn btn-success btn-block">
                        开始年级学习
                    </button>
                </div>
            </div>

            <!-- 自定义学习 -->
            <div class="study-card">
                <div class="card-icon">⚙️</div>
                <h3 class="card-title">自定义学习</h3>
                <p class="card-description">自由选择学习范围和模式</p>
                
                <div class="custom-options">
                    <div class="form-group">
                        <label class="form-label">年级范围：</label>
                        <select id="customGrade" class="form-select">
                            {% for grade in range(3, 7) %}
                            <option value="{{ grade }}" {% if grade == user.grade %}selected{% endif %}>
                                {{ grade }}年级
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button id="startCustomStudy" class="btn btn-info btn-block">
                        开始自定义学习
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="study-progress">
        <h2 class="section-title">📊 学习进度</h2>
        
        <div class="progress-cards">
            <div class="progress-card" id="todayProgress">
                <div class="progress-icon">📅</div>
                <div class="progress-content">
                    <div class="progress-title">今日学习</div>
                    <div class="progress-value" id="todayCount">-</div>
                    <div class="progress-label">个单词</div>
                </div>
            </div>
            
            <div class="progress-card" id="totalProgress">
                <div class="progress-icon">📈</div>
                <div class="progress-content">
                    <div class="progress-title">总学习量</div>
                    <div class="progress-value" id="totalCount">-</div>
                    <div class="progress-label">个单词</div>
                </div>
            </div>
            
            <div class="progress-card" id="masteryProgress">
                <div class="progress-icon">⭐</div>
                <div class="progress-content">
                    <div class="progress-title">掌握程度</div>
                    <div class="progress-value" id="masteryRate">-</div>
                    <div class="progress-label">掌握率</div>
                </div>
            </div>
            
            <div class="progress-card" id="streakProgress">
                <div class="progress-icon">🔥</div>
                <div class="progress-content">
                    <div class="progress-title">连续学习</div>
                    <div class="progress-value" id="streakDays">-</div>
                    <div class="progress-label">天</div>
                </div>
            </div>
        </div>
        
        <div class="progress-actions">
            <a href="{{ url_for('main.study_progress', user_id=user.id) }}" class="btn btn-outline-primary">
                查看详细进度
            </a>
            <a href="{{ url_for('main.study_statistics', user_id=user.id) }}" class="btn btn-outline-secondary">
                学习统计分析
            </a>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userId = {{ user.id }};
    
    // 加载学习进度数据
    loadStudyProgress(userId);
    
    // 按单元学习
    document.getElementById('startUnitStudy').addEventListener('click', function() {
        const unitSelect = document.getElementById('unitSelect');
        const selectedUnit = unitSelect.value;
        
        if (!selectedUnit) {
            WordApp.showAlert('请选择要学习的单元', 'warning');
            return;
        }
        
        window.location.href = `{{ url_for('main.start_study', user_id=user.id) }}?unit=${selectedUnit}`;
    });
    
    // 年级学习
    document.getElementById('startGradeStudy').addEventListener('click', function() {
        window.location.href = `{{ url_for('main.start_study', user_id=user.id) }}`;
    });
    
    // 自定义学习
    document.getElementById('startCustomStudy').addEventListener('click', function() {
        const customGrade = document.getElementById('customGrade').value;
        window.location.href = `{{ url_for('main.start_study', user_id=user.id) }}?grade=${customGrade}`;
    });
});

async function loadStudyProgress(userId) {
    try {
        const response = await ApiClient.study.getProgress(userId);
        if (response.success) {
            updateProgressDisplay(response.data.progress);
        }
        
        const statsResponse = await ApiClient.study.getStatistics(userId, 1);
        if (statsResponse.success) {
            updateTodayProgress(statsResponse.data);
        }
    } catch (error) {
        console.error('加载学习进度失败:', error);
    }
}

function updateProgressDisplay(progress) {
    document.getElementById('totalCount').textContent = progress.studied_words || 0;
    document.getElementById('masteryRate').textContent = (progress.mastery_rate || 0) + '%';
}

function updateTodayProgress(stats) {
    const todayStats = stats.daily_stats.find(s => {
        const today = new Date().toISOString().split('T')[0];
        return s.date === today;
    });
    
    document.getElementById('todayCount').textContent = todayStats ? todayStats.studied_count : 0;
    document.getElementById('streakDays').textContent = calculateStreak(stats.daily_stats);
}

function calculateStreak(dailyStats) {
    if (!dailyStats.length) return 0;
    
    let streak = 0;
    const today = new Date();
    
    for (let i = 0; i < 30; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = checkDate.toISOString().split('T')[0];
        
        const dayStats = dailyStats.find(s => s.date === dateStr);
        if (dayStats && dayStats.studied_count > 0) {
            streak++;
        } else if (i > 0) {
            break;
        }
    }
    
    return streak;
}
</script>
{% endblock %}
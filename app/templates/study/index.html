{% extends "base.html" %}

{% block title %}å­¦ä¹ ä¸­å¿ƒ - {{ user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/study.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <section class="study-header">
        <div class="user-welcome">
            <h1>ğŸ“ å­¦ä¹ ä¸­å¿ƒ</h1>
            <p class="welcome-text">æ¬¢è¿ï¼Œ{{ user.username }}ï¼å¼€å§‹æ‚¨çš„è‹±è¯­å­¦ä¹ ä¹‹æ—…å§</p>
            <div class="user-info-card">
                <span class="info-item">ğŸ“š {{ user.grade }}å¹´çº§</span>
                <span class="info-item">ğŸ“– å½“å‰å•å…ƒï¼šç¬¬{{ user.current_unit }}å•å…ƒ</span>
            </div>
        </div>
    </section>

    <section class="study-options">
        <h2 class="section-title">ğŸ“– å­¦ä¹ é€‰é¡¹</h2>
        
        <div class="study-grid">
            <!-- æŒ‰å•å…ƒå­¦ä¹  -->
            <div class="study-card">
                <div class="card-icon">ğŸ“š</div>
                <h3 class="card-title">æŒ‰å•å…ƒå­¦ä¹ </h3>
                <p class="card-description">é€‰æ‹©ç‰¹å®šå•å…ƒè¿›è¡Œç³»ç»ŸåŒ–å­¦ä¹ </p>
                
                <div class="unit-selector">
                    <label for="unitSelect" class="form-label">é€‰æ‹©å•å…ƒï¼š</label>
                    <select id="unitSelect" class="form-select">
                        <option value="">è¯·é€‰æ‹©å•å…ƒ</option>
                        {% for unit in units %}
                        <option value="{{ unit }}" {% if unit == user.current_unit %}selected{% endif %}>
                            ç¬¬{{ unit }}å•å…ƒ
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="card-actions">
                    <button id="startUnitStudy" class="btn btn-primary btn-block">
                        å¼€å§‹å•å…ƒå­¦ä¹ 
                    </button>
                </div>
            </div>

            <!-- æ™ºèƒ½å¤ä¹  -->
            <div class="study-card">
                <div class="card-icon">ğŸ§ </div>
                <h3 class="card-title">æ™ºèƒ½å¤ä¹ </h3>
                <p class="card-description">ç³»ç»Ÿæ¨èéœ€è¦å¤ä¹ çš„å•è¯</p>
                
                {% if recommended_words %}
                <div class="preview-words">
                    <p class="preview-label">æ¨èå¤ä¹ ï¼š</p>
                    <div class="word-tags">
                        {% for word in recommended_words %}
                        <span class="word-tag">{{ word.word }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="card-actions">
                    <a href="{{ url_for('main.study_review', user_id=user.id) }}" class="btn btn-secondary btn-block">
                        å¼€å§‹æ™ºèƒ½å¤ä¹ 
                    </a>
                </div>
            </div>

            <!-- å…¨å¹´çº§å­¦ä¹  -->
            <div class="study-card">
                <div class="card-icon">ğŸŒŸ</div>
                <h3 class="card-title">å…¨å¹´çº§å­¦ä¹ </h3>
                <p class="card-description">å­¦ä¹ {{ user.grade }}å¹´çº§æ‰€æœ‰å•è¯</p>
                
                <div class="grade-info">
                    <p class="info-text">åŒ…å«{{ user.grade }}å¹´çº§å…¨éƒ¨å•å…ƒå†…å®¹</p>
                </div>
                
                <div class="card-actions">
                    <button id="startGradeStudy" class="btn btn-success btn-block">
                        å¼€å§‹å¹´çº§å­¦ä¹ 
                    </button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰å­¦ä¹  -->
            <div class="study-card">
                <div class="card-icon">âš™ï¸</div>
                <h3 class="card-title">è‡ªå®šä¹‰å­¦ä¹ </h3>
                <p class="card-description">è‡ªç”±é€‰æ‹©å­¦ä¹ èŒƒå›´å’Œæ¨¡å¼</p>
                
                <div class="custom-options">
                    <div class="form-group">
                        <label class="form-label">å¹´çº§èŒƒå›´ï¼š</label>
                        <select id="customGrade" class="form-select">
                            {% for grade in range(3, 7) %}
                            <option value="{{ grade }}" {% if grade == user.grade %}selected{% endif %}>
                                {{ grade }}å¹´çº§
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button id="startCustomStudy" class="btn btn-info btn-block">
                        å¼€å§‹è‡ªå®šä¹‰å­¦ä¹ 
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="study-progress">
        <h2 class="section-title">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
        
        <div class="progress-cards">
            <div class="progress-card" id="todayProgress">
                <div class="progress-icon">ğŸ“…</div>
                <div class="progress-content">
                    <div class="progress-title">ä»Šæ—¥å­¦ä¹ </div>
                    <div class="progress-value" id="todayCount">-</div>
                    <div class="progress-label">ä¸ªå•è¯</div>
                </div>
            </div>
            
            <div class="progress-card" id="totalProgress">
                <div class="progress-icon">ğŸ“ˆ</div>
                <div class="progress-content">
                    <div class="progress-title">æ€»å­¦ä¹ é‡</div>
                    <div class="progress-value" id="totalCount">-</div>
                    <div class="progress-label">ä¸ªå•è¯</div>
                </div>
            </div>
            
            <div class="progress-card" id="masteryProgress">
                <div class="progress-icon">â­</div>
                <div class="progress-content">
                    <div class="progress-title">æŒæ¡ç¨‹åº¦</div>
                    <div class="progress-value" id="masteryRate">-</div>
                    <div class="progress-label">æŒæ¡ç‡</div>
                </div>
            </div>
            
            <div class="progress-card" id="streakProgress">
                <div class="progress-icon">ğŸ”¥</div>
                <div class="progress-content">
                    <div class="progress-title">è¿ç»­å­¦ä¹ </div>
                    <div class="progress-value" id="streakDays">-</div>
                    <div class="progress-label">å¤©</div>
                </div>
            </div>
        </div>
        
        <div class="progress-actions">
            <a href="{{ url_for('main.study_progress', user_id=user.id) }}" class="btn btn-outline-primary">
                æŸ¥çœ‹è¯¦ç»†è¿›åº¦
            </a>
            <a href="{{ url_for('main.study_statistics', user_id=user.id) }}" class="btn btn-outline-secondary">
                å­¦ä¹ ç»Ÿè®¡åˆ†æ
            </a>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userId = {{ user.id }};
    
    // åŠ è½½å­¦ä¹ è¿›åº¦æ•°æ®
    loadStudyProgress(userId);
    
    // æŒ‰å•å…ƒå­¦ä¹ 
    document.getElementById('startUnitStudy').addEventListener('click', function() {
        const unitSelect = document.getElementById('unitSelect');
        const selectedUnit = unitSelect.value;
        
        if (!selectedUnit) {
            WordApp.showAlert('è¯·é€‰æ‹©è¦å­¦ä¹ çš„å•å…ƒ', 'warning');
            return;
        }
        
        window.location.href = `{{ url_for('main.start_study', user_id=user.id) }}?unit=${selectedUnit}`;
    });
    
    // å¹´çº§å­¦ä¹ 
    document.getElementById('startGradeStudy').addEventListener('click', function() {
        window.location.href = `{{ url_for('main.start_study', user_id=user.id) }}`;
    });
    
    // è‡ªå®šä¹‰å­¦ä¹ 
    document.getElementById('startCustomStudy').addEventListener('click', function() {
        const customGrade = document.getElementById('customGrade').value;
        window.location.href = `{{ url_for('main.start_study', user_id=user.id) }}?grade=${customGrade}`;
    });
});

async function loadStudyProgress(userId) {
    try {
        const response = await ApiClient.study.getProgress(userId);
        if (response.success) {
            updateProgressDisplay(response.data.progress);
        }
        
        const statsResponse = await ApiClient.study.getStatistics(userId, 1);
        if (statsResponse.success) {
            updateTodayProgress(statsResponse.data);
        }
    } catch (error) {
        console.error('åŠ è½½å­¦ä¹ è¿›åº¦å¤±è´¥:', error);
    }
}

function updateProgressDisplay(progress) {
    document.getElementById('totalCount').textContent = progress.studied_words || 0;
    document.getElementById('masteryRate').textContent = (progress.mastery_rate || 0) + '%';
}

function updateTodayProgress(stats) {
    const todayStats = stats.daily_stats.find(s => {
        const today = new Date().toISOString().split('T')[0];
        return s.date === today;
    });
    
    document.getElementById('todayCount').textContent = todayStats ? todayStats.studied_count : 0;
    document.getElementById('streakDays').textContent = calculateStreak(stats.daily_stats);
}

function calculateStreak(dailyStats) {
    if (!dailyStats.length) return 0;
    
    let streak = 0;
    const today = new Date();
    
    for (let i = 0; i < 30; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = checkDate.toISOString().split('T')[0];
        
        const dayStats = dailyStats.find(s => s.date === dateStr);
        if (dayStats && dayStats.studied_count > 0) {
            streak++;
        } else if (i > 0) {
            break;
        }
    }
    
    return streak;
}
</script>
{% endblock %}
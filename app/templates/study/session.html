{% extends "base.html" %}

{% block title %}å­¦ä¹ ä¼šè¯ - {{ user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/study-session.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <section class="study-session">
        <div class="session-header">
            <div class="session-info">
                <h1 class="session-title">ğŸ“– å­¦ä¹ ä¼šè¯</h1>
                <div class="session-meta">
                    <span class="meta-item">ğŸ‘¤ {{ user.username }}</span>
                    <span class="meta-item">ğŸ“š {{ session.words|length }}ä¸ªå•è¯</span>
                    <span class="meta-item" id="sessionTime">â±ï¸ 00:00</span>
                </div>
            </div>
            
            <div class="session-progress">
                <div class="progress-info">
                    <span id="currentIndex">1</span> / <span id="totalWords">{{ session.words|length }}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="word-card" id="wordCard">
            <!-- å•è¯å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <div class="study-controls">
            <button id="prevBtn" class="btn btn-outline-secondary" disabled>
                â¬…ï¸ ä¸Šä¸€ä¸ª
            </button>
            
            <div class="mastery-controls">
                <p class="mastery-label">æŒæ¡ç¨‹åº¦ï¼š</p>
                <div class="mastery-buttons">
                    <button class="mastery-btn" data-level="1">ğŸ˜Ÿ ä¸ä¼š</button>
                    <button class="mastery-btn" data-level="2">ğŸ¤” æœ‰å°è±¡</button>
                    <button class="mastery-btn" data-level="3">ğŸ˜Š è®¤è¯†</button>
                    <button class="mastery-btn" data-level="4">ğŸ˜„ ç†Ÿç»ƒ</button>
                    <button class="mastery-btn" data-level="5">ğŸŒŸ æŒæ¡</button>
                </div>
            </div>
            
            <button id="nextBtn" class="btn btn-primary">
                ä¸‹ä¸€ä¸ª â¡ï¸
            </button>
        </div>

        <div class="session-actions">
            <button id="pauseBtn" class="btn btn-outline-warning">â¸ï¸ æš‚åœ</button>
            <button id="finishBtn" class="btn btn-success">âœ… å®Œæˆå­¦ä¹ </button>
            <a href="{{ url_for('main.study_page', user_id=user.id) }}" class="btn btn-outline-danger">
                âŒ é€€å‡ºå­¦ä¹ 
            </a>
        </div>
    </section>
</div>

<!-- å•è¯è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="wordDetailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å•è¯è¯¦æƒ…</h3>
            <button class="modal-close" id="closeModal">Ã—</button>
        </div>
        <div class="modal-body" id="wordDetailContent">
            <!-- è¯¦ç»†å†…å®¹ -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
class StudySession {
    constructor(sessionData, userId) {
        this.sessionData = sessionData;
        this.userId = userId;
        this.currentIndex = 0;
        this.words = sessionData.words;
        this.studyRecord = new Map(); // è®°å½•å­¦ä¹ è¿›åº¦
        this.startTime = new Date();
        this.timer = null;
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.startTimer();
        this.renderCurrentWord();
        this.updateProgress();
    }
    
    setupEventListeners() {
        // å¯¼èˆªæŒ‰é’®
        document.getElementById('prevBtn').addEventListener('click', () => this.prevWord());
        document.getElementById('nextBtn').addEventListener('click', () => this.nextWord());
        
        // æŒæ¡ç¨‹åº¦æŒ‰é’®
        document.querySelectorAll('.mastery-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.setMastery(parseInt(e.target.dataset.level)));
        });
        
        // ä¼šè¯æ§åˆ¶
        document.getElementById('pauseBtn').addEventListener('click', () => this.pauseSession());
        document.getElementById('finishBtn').addEventListener('click', () => this.finishSession());
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
    }
    
    renderCurrentWord() {
        const word = this.words[this.currentIndex];
        if (!word) return;
        
        const wordCard = document.getElementById('wordCard');
        wordCard.innerHTML = `
            <div class="word-main">
                <div class="word-english">
                    <h2 class="english-text">${word.word}</h2>
                    <button class="audio-btn" onclick="playAudio('${word.word}')">ğŸ”Š</button>
                </div>
                
                <div class="word-phonetic">
                    <span class="phonetic">${word.phonetic || ''}</span>
                </div>
                
                <div class="word-meaning">
                    <p class="meaning-text">${word.chinese_meaning}</p>
                </div>
            </div>
            
            <div class="word-details" id="wordDetails" style="display: none;">
                <div class="detail-section">
                    <h4>ğŸ”¤ è‡ªç„¶æ‹¼è¯»</h4>
                    <p class="phonics">${word.phonics_breakdown || 'æš‚æ— æ‹¼è¯»ä¿¡æ¯'}</p>
                </div>
                
                <div class="detail-section">
                    <h4>ğŸ’­ è®°å¿†æ–¹æ³•</h4>
                    <p class="memory-method">${word.memory_method || 'æš‚æ— è®°å¿†æ–¹æ³•'}</p>
                </div>
            </div>
            
            <div class="word-actions">
                <button class="btn btn-outline-info" onclick="toggleDetails()">
                    ğŸ“ æŸ¥çœ‹è¯¦æƒ…
                </button>
                <button class="btn btn-outline-secondary" onclick="markDifficult()">
                    â­ æ ‡è®°éš¾è¯
                </button>
            </div>
        `;
        
        this.updateMasteryDisplay();
    }
    
    updateMasteryDisplay() {
        const currentRecord = this.studyRecord.get(this.currentIndex);
        const buttons = document.querySelectorAll('.mastery-btn');
        
        buttons.forEach(btn => btn.classList.remove('selected'));
        
        if (currentRecord) {
            const selectedBtn = document.querySelector(`[data-level="${currentRecord.level}"]`);
            if (selectedBtn) selectedBtn.classList.add('selected');
        }
    }
    
    setMastery(level) {
        const word = this.words[this.currentIndex];
        this.studyRecord.set(this.currentIndex, {
            wordId: word.id,
            level: level,
            timestamp: new Date()
        });
        
        this.updateMasteryDisplay();
        
        // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
        this.saveProgress(word.id, level);
        
        // å¦‚æœé€‰æ‹©äº†æŒæ¡ç¨‹åº¦ï¼Œè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ä¸ª
        setTimeout(() => {
            if (this.currentIndex < this.words.length - 1) {
                this.nextWord();
            }
        }, 500);
    }
    
    async saveProgress(wordId, masteryLevel) {
        try {
            await ApiClient.study.recordProgress(this.userId, wordId, masteryLevel);
        } catch (error) {
            console.error('ä¿å­˜å­¦ä¹ è¿›åº¦å¤±è´¥:', error);
        }
    }
    
    nextWord() {
        if (this.currentIndex < this.words.length - 1) {
            this.currentIndex++;
            this.renderCurrentWord();
            this.updateProgress();
            this.updateNavigation();
        }
    }
    
    prevWord() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            this.renderCurrentWord();
            this.updateProgress();
            this.updateNavigation();
        }
    }
    
    updateProgress() {
        document.getElementById('currentIndex').textContent = this.currentIndex + 1;
        document.getElementById('totalWords').textContent = this.words.length;
        
        const progressPercent = ((this.currentIndex + 1) / this.words.length) * 100;
        document.getElementById('progressFill').style.width = progressPercent + '%';
    }
    
    updateNavigation() {
        document.getElementById('prevBtn').disabled = this.currentIndex === 0;
        document.getElementById('nextBtn').disabled = this.currentIndex === this.words.length - 1;
    }
    
    startTimer() {
        this.timer = setInterval(() => {
            const elapsed = new Date() - this.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('sessionTime').textContent = 
                `â±ï¸ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
    
    pauseSession() {
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
            document.getElementById('pauseBtn').textContent = 'â–¶ï¸ ç»§ç»­';
            document.getElementById('pauseBtn').onclick = () => this.resumeSession();
        }
    }
    
    resumeSession() {
        this.startTimer();
        document.getElementById('pauseBtn').textContent = 'â¸ï¸ æš‚åœ';
        document.getElementById('pauseBtn').onclick = () => this.pauseSession();
    }
    
    finishSession() {
        const studiedCount = this.studyRecord.size;
        const totalTime = Math.floor((new Date() - this.startTime) / 1000);
        
        if (confirm(`å­¦ä¹ å®Œæˆï¼\\nå­¦ä¹ äº† ${studiedCount} ä¸ªå•è¯\\nç”¨æ—¶ ${Math.floor(totalTime/60)} åˆ† ${totalTime%60} ç§’\\n\\nç¡®å®šç»“æŸå­¦ä¹ å—ï¼Ÿ`)) {
            window.location.href = `{{ url_for('main.study_page', user_id=user.id) }}?completed=1`;
        }
    }
    
    handleKeyboard(e) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                this.prevWord();
                break;
            case 'ArrowRight':
                e.preventDefault();
                this.nextWord();
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                this.setMastery(parseInt(e.key));
                break;
            case 'Escape':
                e.preventDefault();
                this.pauseSession();
                break;
        }
    }
}

// å…¨å±€å‡½æ•°
function toggleDetails() {
    const details = document.getElementById('wordDetails');
    const btn = event.target;
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.textContent = 'ğŸ“ éšè—è¯¦æƒ…';
    } else {
        details.style.display = 'none';
        btn.textContent = 'ğŸ“ æŸ¥çœ‹è¯¦æƒ…';
    }
}

function playAudio(word) {
    // è¿™é‡Œå¯ä»¥é›†æˆè¯­éŸ³åˆæˆAPI
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
    }
}

function markDifficult() {
    WordApp.showAlert('å·²æ ‡è®°ä¸ºéš¾è¯ï¼Œå°†åœ¨å¤ä¹ ä¸­é‡ç‚¹ç»ƒä¹ ', 'info');
}

// åˆå§‹åŒ–å­¦ä¹ ä¼šè¯
document.addEventListener('DOMContentLoaded', function() {
    const sessionData = {{ session|tojson }};
    const userId = {{ user.id }};
    
    window.studySession = new StudySession(sessionData, userId);
});
</script>
{% endblock %}
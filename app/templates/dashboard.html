{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - {{ user.username }}{% endblock %}

{% block content %}
<div class="container">
    <section class="dashboard-header">
        <div class="welcome-banner">
            <h1>ğŸ  å­¦ä¹ ä»ªè¡¨æ¿</h1>
            <p class="welcome-message">æ¬¢è¿å›æ¥ï¼Œ{{ user.username }}ï¼ç»§ç»­æ‚¨çš„è‹±è¯­å­¦ä¹ ä¹‹æ—…</p>
            <div class="user-badge">
                <span class="badge-grade">{{ user.grade }}å¹´çº§</span>
                <span class="badge-unit">ç¬¬{{ user.current_unit }}å•å…ƒ</span>
            </div>
        </div>
    </section>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <section class="quick-actions">
        <h2 class="section-title">âš¡ å¿«é€Ÿæ“ä½œ</h2>
        <div class="actions-grid">
            <a href="{{ url_for('main.study_page', user_id=user.id) }}" class="action-card study-action">
                <div class="action-icon">ğŸ“–</div>
                <div class="action-title">å¼€å§‹å­¦ä¹ </div>
                <div class="action-desc">ç»§ç»­å­¦ä¹ æ–°å•è¯</div>
            </a>
            
            <a href="{{ url_for('main.test_page', user_id=user.id) }}" class="action-card test-action">
                <div class="action-icon">ğŸ“</div>
                <div class="action-title">è¿›è¡Œæµ‹éªŒ</div>
                <div class="action-desc">æ£€éªŒå­¦ä¹ æˆæœ</div>
            </a>
            
            <a href="{{ url_for('main.study_review', user_id=user.id) }}" class="action-card review-action">
                <div class="action-icon">ğŸ§ </div>
                <div class="action-title">æ™ºèƒ½å¤ä¹ </div>
                <div class="action-desc">å¤ä¹ è–„å¼±å•è¯</div>
            </a>
            
            <a href="{{ url_for('main.study_progress', user_id=user.id) }}" class="action-card progress-action">
                <div class="action-icon">ğŸ“Š</div>
                <div class="action-title">æŸ¥çœ‹è¿›åº¦</div>
                <div class="action-desc">å­¦ä¹ æ•°æ®åˆ†æ</div>
            </a>
        </div>
    </section>

    <!-- å­¦ä¹ æ¦‚å†µ -->
    <section class="learning-overview">
        <h2 class="section-title">ğŸ“ˆ å­¦ä¹ æ¦‚å†µ</h2>
        <div class="overview-grid" id="overviewGrid">
            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ è½½ -->
            <div class="overview-card loading">
                <div class="card-icon">ğŸ“š</div>
                <div class="card-content">
                    <div class="card-label">å·²å­¦ä¹ å•è¯</div>
                    <div class="card-value" id="studiedWords">-</div>
                </div>
            </div>
            
            <div class="overview-card loading">
                <div class="card-icon">â­</div>
                <div class="card-content">
                    <div class="card-label">å·²æŒæ¡å•è¯</div>
                    <div class="card-value" id="masteredWords">-</div>
                </div>
            </div>
            
            <div class="overview-card loading">
                <div class="card-icon">ğŸ“Š</div>
                <div class="card-content">
                    <div class="card-label">æŒæ¡ç‡</div>
                    <div class="card-value" id="masteryRate">-</div>
                </div>
            </div>
            
            <div class="overview-card loading">
                <div class="card-icon">ğŸ“</div>
                <div class="card-content">
                    <div class="card-label">æµ‹éªŒæ¬¡æ•°</div>
                    <div class="card-value" id="testCount">-</div>
                </div>
            </div>
        </div>
    </section>

    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <section class="recent-activity">
        <h2 class="section-title">ğŸ“‹ æœ€è¿‘æ´»åŠ¨</h2>
        <div class="activity-container">
            <div class="activity-tabs">
                <button class="tab-btn active" data-tab="recent-study">æœ€è¿‘å­¦ä¹ </button>
                <button class="tab-btn" data-tab="recent-tests">æœ€è¿‘æµ‹éªŒ</button>
            </div>
            
            <div class="tab-content">
                <div class="tab-pane active" id="recent-study">
                    <div class="activity-list" id="recentStudyList">
                        <!-- æœ€è¿‘å­¦ä¹ è®°å½• -->
                    </div>
                </div>
                
                <div class="tab-pane" id="recent-tests">
                    <div class="activity-list" id="recentTestsList">
                        <!-- æœ€è¿‘æµ‹éªŒè®°å½• -->
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: var(--white);
    padding: var(--spacing-xxl) 0;
    margin-bottom: var(--spacing-xl);
    text-align: center;
    border-radius: var(--border-radius-lg);
}

.welcome-banner h1 {
    font-size: var(--font-size-3xl);
    margin-bottom: var(--spacing-md);
}

.welcome-message {
    font-size: var(--font-size-lg);
    margin-bottom: var(--spacing-lg);
    opacity: 0.9;
}

.user-badge {
    display: inline-flex;
    gap: var(--spacing-sm);
}

.badge-grade,
.badge-unit {
    background: rgba(255, 255, 255, 0.2);
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
}

.section-title {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--spacing-xl);
    text-align: center;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xxl);
}

.action-card {
    background: var(--white);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-base);
    text-align: center;
    text-decoration: none;
    transition: all var(--transition-base);
    border: 1px solid var(--border-light);
}

.action-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    text-decoration: none;
}

.action-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-md);
}

.action-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
}

.action-desc {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xxl);
}

.overview-card {
    background: var(--white);
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-base);
    text-align: center;
    border: 1px solid var(--border-light);
}

.card-icon {
    font-size: 2rem;
    margin-bottom: var(--spacing-sm);
}

.card-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xs);
}

.card-value {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-color);
}

.activity-container {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-base);
    border: 1px solid var(--border-light);
    overflow: hidden;
}

.activity-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-light);
}

.tab-btn {
    flex: 1;
    padding: var(--spacing-md);
    border: none;
    background: var(--bg-light);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.tab-btn.active {
    background: var(--white);
    border-bottom: 2px solid var(--primary-color);
}

.tab-content {
    padding: var(--spacing-lg);
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

.activity-list {
    min-height: 200px;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .overview-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-header {
        padding: var(--spacing-xl) var(--spacing-md);
    }
}

@media (max-width: 480px) {
    .actions-grid,
    .overview-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userId = {{ user.id }};
    
    // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
    loadDashboardData(userId);
    
    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            switchTab(tabId);
        });
    });
});

async function loadDashboardData(userId) {
    try {
        const response = await ApiClient.users.getDashboard(userId);
        if (response.success) {
            updateDashboardStats(response.data);
            loadRecentActivity(response.data);
        }
    } catch (error) {
        console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
    }
}

function updateDashboardStats(data) {
    document.getElementById('studiedWords').textContent = data.study_progress.total_studied;
    document.getElementById('masteredWords').textContent = data.study_progress.mastered;
    document.getElementById('masteryRate').textContent = data.study_progress.mastery_rate + '%';
    document.getElementById('testCount').textContent = data.test_statistics.total_tests;
    
    // ç§»é™¤åŠ è½½çŠ¶æ€
    document.querySelectorAll('.overview-card').forEach(card => {
        card.classList.remove('loading');
    });
}

function loadRecentActivity(data) {
    // æœ€è¿‘å­¦ä¹ è®°å½•
    const studyList = document.getElementById('recentStudyList');
    if (data.recent_tests && data.recent_tests.length > 0) {
        studyList.innerHTML = data.recent_tests.slice(0, 5).map(test => `
            <div class="activity-item">
                <div class="activity-icon">ğŸ“</div>
                <div class="activity-content">
                    <div class="activity-title">${test.test_type_name}æµ‹éªŒ</div>
                    <div class="activity-desc">å¾—åˆ†: ${test.score}%</div>
                </div>
                <div class="activity-time">${formatRelativeTime(test.tested_at)}</div>
            </div>
        `).join('');
    } else {
        studyList.innerHTML = '<p class="empty-text">æš‚æ— å­¦ä¹ è®°å½•</p>';
    }
    
    // æœ€è¿‘æµ‹éªŒè®°å½•
    const testsList = document.getElementById('recentTestsList');
    if (data.recent_tests && data.recent_tests.length > 0) {
        testsList.innerHTML = data.recent_tests.map(test => `
            <div class="activity-item">
                <div class="activity-icon">ğŸ“Š</div>
                <div class="activity-content">
                    <div class="activity-title">${test.test_type_name}</div>
                    <div class="activity-desc">${test.correct_answers}/${test.total_questions} æ­£ç¡®</div>
                </div>
                <div class="activity-score score-${test.score >= 80 ? 'high' : test.score >= 60 ? 'medium' : 'low'}">
                    ${test.score}%
                </div>
            </div>
        `).join('');
    } else {
        testsList.innerHTML = '<p class="empty-text">æš‚æ— æµ‹éªŒè®°å½•</p>';
    }
}

function switchTab(tabId) {
    // åˆ‡æ¢æ ‡ç­¾æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    
    // åˆ‡æ¢æ ‡ç­¾é¡µå†…å®¹
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(tabId).classList.add('active');
}

function formatRelativeTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffHours < 1) return 'åˆšåˆš';
    if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
    if (diffDays < 7) return `${diffDays}å¤©å‰`;
    return date.toLocaleDateString();
}
</script>
{% endblock %}
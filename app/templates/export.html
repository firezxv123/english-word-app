{% extends "base.html" %}

{% block title %}æ•°æ®å¯¼å‡º - å°å­¦è‹±è¯­å•è¯å¤ä¹ åº”ç”¨{% endblock %}

{% block extra_css %}
<style>
.export-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--spacing-lg);
}

.export-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-xl) 0;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: var(--white);
    border-radius: var(--border-radius-lg);
}

.export-header h1 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-xxl);
}

.export-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--spacing-xl);
}

.export-section {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.section-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--primary-light);
}

.section-icon {
    font-size: 2rem;
    color: var(--primary-color);
}

.section-title {
    margin: 0;
    color: var(--primary-color);
    font-size: var(--font-size-xl);
}

.export-form {
    margin-bottom: var(--spacing-lg);
}

.form-row {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    align-items: end;
}

.form-row .form-group {
    flex: 1;
}

.format-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-md);
}

.format-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-md);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius-md);
    background: var(--white);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
    color: var(--text-primary);
}

.format-btn:hover {
    border-color: var(--primary-color);
    background: var(--primary-light);
    color: var(--primary-color);
}

.format-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.format-icon {
    font-size: 1.5rem;
}

.format-name {
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
}

.format-desc {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    text-align: center;
}

.user-selector {
    margin-bottom: var(--spacing-lg);
}

.user-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    background: var(--gray-50);
}

.user-item {
    padding: var(--spacing-sm) var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.user-item:hover {
    background: var(--primary-light);
}

.user-item.selected {
    background: var(--primary-color);
    color: var(--white);
}

.user-item:last-child {
    border-bottom: none;
}

.user-name {
    font-weight: var(--font-weight-medium);
}

.user-grade {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.user-item.selected .user-grade {
    color: rgba(255, 255, 255, 0.8);
}

.preview-section {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
}

.preview-content {
    background: var(--gray-50);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-md);
    font-family: monospace;
    font-size: var(--font-size-sm);
    max-height: 200px;
    overflow: auto;
}

.export-progress {
    margin-top: var(--spacing-md);
    display: none;
}

.export-progress.show {
    display: block;
}

@media (max-width: 768px) {
    .export-sections {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .format-buttons {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="export-container">
    <section class="export-header">
        <h1>ğŸ“¤ æ•°æ®å¯¼å‡º</h1>
        <p>å¯¼å‡ºè¯åº“å’Œå­¦ä¹ æŠ¥å‘Šæ•°æ®</p>
    </section>

    <div class="export-sections">
        <!-- è¯åº“å¯¼å‡º -->
        <div class="export-section">
            <div class="section-header">
                <span class="section-icon">ğŸ“š</span>
                <h2 class="section-title">è¯åº“å¯¼å‡º</h2>
            </div>

            <form class="export-form" id="wordsExportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="wordsGrade" class="form-label">å¹´çº§ï¼š</label>
                        <select id="wordsGrade" name="grade" class="form-select">
                            <option value="">æ‰€æœ‰å¹´çº§</option>
                            <option value="3">ä¸‰å¹´çº§</option>
                            <option value="4">å››å¹´çº§</option>
                            <option value="5">äº”å¹´çº§</option>
                            <option value="6">å…­å¹´çº§</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="wordsUnit" class="form-label">å•å…ƒï¼š</label>
                        <select id="wordsUnit" name="unit" class="form-select">
                            <option value="">æ‰€æœ‰å•å…ƒ</option>
                        </select>
                    </div>
                </div>

                <div class="format-buttons" id="wordsFormats">
                    <a href="#" class="format-btn" data-format="csv">
                        <span class="format-icon">ğŸ“„</span>
                        <span class="format-name">CSVæ ¼å¼</span>
                        <span class="format-desc">Excelå…¼å®¹</span>
                    </a>
                    <a href="#" class="format-btn" data-format="json">
                        <span class="format-icon">ğŸ”§</span>
                        <span class="format-name">JSONæ ¼å¼</span>
                        <span class="format-desc">ç¨‹åºæ•°æ®</span>
                    </a>
                    <a href="#" class="format-btn" data-format="pdf">
                        <span class="format-icon">ğŸ“‹</span>
                        <span class="format-name">PDFæ ¼å¼</span>
                        <span class="format-desc">æ‰“å°å‹å¥½</span>
                    </a>
                </div>

                <div class="export-progress" id="wordsProgress">
                    <div class="progress-text">æ­£åœ¨å¯¼å‡º...</div>
                </div>
            </form>
        </div>

        <!-- å­¦ä¹ æŠ¥å‘Šå¯¼å‡º -->
        <div class="export-section">
            <div class="section-header">
                <span class="section-icon">ğŸ“Š</span>
                <h2 class="section-title">å­¦ä¹ æŠ¥å‘Šå¯¼å‡º</h2>
            </div>

            <div class="user-selector">
                <label class="form-label">é€‰æ‹©ç”¨æˆ·ï¼š</label>
                <div class="user-list" id="userList">
                    <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <div class="format-buttons" id="reportFormats">
                <a href="#" class="format-btn" data-format="csv">
                    <span class="format-icon">ğŸ“„</span>
                    <span class="format-name">å­¦ä¹ è®°å½•</span>
                    <span class="format-desc">CSVæ ¼å¼</span>
                </a>
                <a href="#" class="format-btn" data-format="pdf">
                    <span class="format-icon">ğŸ“‹</span>
                    <span class="format-name">å­¦ä¹ æŠ¥å‘Š</span>
                    <span class="format-desc">PDFæ ¼å¼</span>
                </a>
            </div>

            <div class="export-progress" id="reportProgress">
                <div class="progress-text">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const wordsGrade = document.getElementById('wordsGrade');
    const wordsUnit = document.getElementById('wordsUnit');
    const wordsFormats = document.getElementById('wordsFormats');
    const reportFormats = document.getElementById('reportFormats');
    const userList = document.getElementById('userList');
    
    let selectedUser = null;
    
    // å¹´çº§å˜åŒ–æ—¶æ›´æ–°å•å…ƒé€‰é¡¹
    wordsGrade.addEventListener('change', function() {
        updateUnitOptions(this.value);
    });
    
    // è¯åº“å¯¼å‡ºæ ¼å¼æŒ‰é’®
    wordsFormats.addEventListener('click', function(e) {
        if (e.target.closest('.format-btn')) {
            e.preventDefault();
            const formatBtn = e.target.closest('.format-btn');
            const format = formatBtn.dataset.format;
            exportWords(format);
        }
    });
    
    // å­¦ä¹ æŠ¥å‘Šå¯¼å‡ºæ ¼å¼æŒ‰é’®
    reportFormats.addEventListener('click', function(e) {
        if (e.target.closest('.format-btn')) {
            e.preventDefault();
            const formatBtn = e.target.closest('.format-btn');
            const format = formatBtn.dataset.format;
            
            if (!selectedUser) {\n                showNotification('è¯·å…ˆé€‰æ‹©ç”¨æˆ·', 'warning');\n                return;\n            }\n            \n            exportReport(selectedUser.id, format);\n        }\n    });\n    \n    // ç”¨æˆ·åˆ—è¡¨ç‚¹å‡»\n    userList.addEventListener('click', function(e) {\n        const userItem = e.target.closest('.user-item');\n        if (userItem) {\n            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€\n            document.querySelectorAll('.user-item').forEach(item => {\n                item.classList.remove('selected');\n            });\n            \n            // è®¾ç½®å½“å‰é€‰ä¸­\n            userItem.classList.add('selected');\n            selectedUser = {\n                id: parseInt(userItem.dataset.userId),\n                username: userItem.dataset.username\n            };\n        }\n    });\n    \n    // æ›´æ–°å•å…ƒé€‰é¡¹\n    function updateUnitOptions(grade) {\n        wordsUnit.innerHTML = '<option value=\"\">æ‰€æœ‰å•å…ƒ</option>';\n        \n        if (!grade) return;\n        \n        ApiClient.get(`/words/units/${grade}`)\n            .then(response => {\n                if (response.success) {\n                    response.data.forEach(unit => {\n                        const option = document.createElement('option');\n                        option.value = unit;\n                        option.textContent = `ç¬¬${unit}å•å…ƒ`;\n                        wordsUnit.appendChild(option);\n                    });\n                }\n            })\n            .catch(error => {\n                console.error('è·å–å•å…ƒåˆ—è¡¨å¤±è´¥:', error);\n            });\n    }\n    \n    // å¯¼å‡ºå•è¯\n    function exportWords(format) {\n        const grade = wordsGrade.value;\n        const unit = wordsUnit.value;\n        \n        const params = new URLSearchParams();\n        if (grade) params.append('grade', grade);\n        if (unit) params.append('unit', unit);\n        \n        const progressElement = document.getElementById('wordsProgress');\n        progressElement.classList.add('show');\n        \n        const url = `/api/export/words/${format}?${params.toString()}`;\n        \n        // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥\n        const link = document.createElement('a');\n        link.href = url;\n        link.style.display = 'none';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        \n        // éšè—è¿›åº¦æ¡\n        setTimeout(() => {\n            progressElement.classList.remove('show');\n            showNotification('å¯¼å‡ºå®Œæˆ', 'success');\n        }, 1000);\n    }\n    \n    // å¯¼å‡ºå­¦ä¹ æŠ¥å‘Š\n    function exportReport(userId, format) {\n        const progressElement = document.getElementById('reportProgress');\n        progressElement.classList.add('show');\n        \n        const url = `/api/export/study-report/${userId}/${format}`;\n        \n        // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥\n        const link = document.createElement('a');\n        link.href = url;\n        link.style.display = 'none';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        \n        // éšè—è¿›åº¦æ¡\n        setTimeout(() => {\n            progressElement.classList.remove('show');\n            showNotification('æŠ¥å‘Šç”Ÿæˆå®Œæˆ', 'success');\n        }, 1000);\n    }\n    \n    // åŠ è½½ç”¨æˆ·åˆ—è¡¨\n    function loadUsers() {\n        ApiClient.get('/users')\n            .then(response => {\n                if (response.success) {\n                    renderUserList(response.data);\n                } else {\n                    userList.innerHTML = '<div class=\"user-item\">åŠ è½½ç”¨æˆ·å¤±è´¥</div>';\n                }\n            })\n            .catch(error => {\n                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);\n                userList.innerHTML = '<div class=\"user-item\">åŠ è½½ç”¨æˆ·å¤±è´¥</div>';\n            });\n    }\n    \n    // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨\n    function renderUserList(users) {\n        if (users.length === 0) {\n            userList.innerHTML = '<div class=\"user-item\">æš‚æ— ç”¨æˆ·</div>';\n            return;\n        }\n        \n        userList.innerHTML = users.map(user => `\n            <div class=\"user-item\" data-user-id=\"${user.id}\" data-username=\"${user.username}\">\n                <div class=\"user-name\">${user.username}</div>\n                <div class=\"user-grade\">${user.grade}å¹´çº§</div>\n            </div>\n        `).join('');\n    }\n    \n    // æ£€æŸ¥PDFæ”¯æŒ\n    function checkPDFSupport() {\n        ApiClient.get('/export/formats')\n            .then(response => {\n                if (response.success) {\n                    const formats = response.data;\n                    \n                    // æ£€æŸ¥å•è¯å¯¼å‡ºæ˜¯å¦æ”¯æŒPDF\n                    const wordsPdfSupported = formats.words.some(f => f.format === 'pdf');\n                    if (!wordsPdfSupported) {\n                        const pdfBtn = wordsFormats.querySelector('[data-format=\"pdf\"]');\n                        if (pdfBtn) {\n                            pdfBtn.classList.add('disabled');\n                            pdfBtn.querySelector('.format-desc').textContent = 'éœ€è¦å®‰è£…PDFåº“';\n                        }\n                    }\n                    \n                    // æ£€æŸ¥æŠ¥å‘Šå¯¼å‡ºæ˜¯å¦æ”¯æŒPDF\n                    const reportPdfSupported = formats.reports.some(f => f.format === 'pdf');\n                    if (!reportPdfSupported) {\n                        const pdfBtn = reportFormats.querySelector('[data-format=\"pdf\"]');\n                        if (pdfBtn) {\n                            pdfBtn.classList.add('disabled');\n                            pdfBtn.querySelector('.format-desc').textContent = 'éœ€è¦å®‰è£…PDFåº“';\n                        }\n                    }\n                }\n            })\n            .catch(error => {\n                console.error('æ£€æŸ¥å¯¼å‡ºæ ¼å¼å¤±è´¥:', error);\n            });\n    }\n    \n    // åˆå§‹åŒ–\n    loadUsers();\n    checkPDFSupport();\n});\n</script>\n{% endblock %}